<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SANKO - Tủ bếp Inox hệ Module</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="Logo.png">
    <link rel="shortcut icon" type="image/png" href="Logo.png">
    <link rel="apple-touch-icon" href="Logo.png">
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="SANKO - Hệ thống tủ bếp Inox Module cao cấp. Tạo báo giá online, thiết kế tủ bếp hiện đại và chuyên nghiệp.">
    <meta name="keywords" content="SANKO, tủ bếp inox, module, báo giá, kitchen, cabinet">
    <meta name="author" content="SANKO">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://baogia.sanko.com.vn">
    <meta property="og:title" content="SANKO - Tủ bếp Inox hệ Module">
    <meta property="og:description" content="Hệ thống tủ bếp Inox Module cao cấp. Tạo báo giá online, thiết kế tủ bếp hiện đại và chuyên nghiệp.">
    <meta property="og:image" content="https://baogia.sanko.com.vn/Logo.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://baogia.sanko.com.vn">
    <meta property="twitter:title" content="SANKO - Tủ bếp Inox hệ Module">
    <meta property="twitter:description" content="Hệ thống tủ bếp Inox Module cao cấp. Tạo báo giá online, thiết kế tủ bếp hiện đại và chuyên nghiệp.">
    <meta property="twitter:image" content="https://baogia.sanko.com.vn/Logo.png">
    
    <!-- Microsoft Tiles -->
    <meta name="msapplication-TileImage" content="Logo.png">
    <meta name="msapplication-TileColor" content="#1E3A5F">
    
    <!-- Theme Color -->
    <meta name="theme-color" content="#1E3A5F">
    <!-- Google Fonts for Vietnamese support -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #FFFFFF;
            color: #1E2F3F;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #1E3A5F 0%, #2A4B6D 100%);
            color: white;
            padding: 30px;
            margin-bottom: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(30,58,95,0.25);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            position: relative;
        }

        .logo {
            height: 120px;
            width: auto;
            object-fit: contain;
            position: absolute;
            left: 20px;
        }

        .header-text {
            text-align: center;
            margin: 0;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .controls {
            background: #F0F9FF;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(59,130,246,0.1);
            margin-bottom: 30px;
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 20px;
            align-items: center;
            border: 1px solid #E0F2FE;
        }

        .search-box, .filter-select {
            padding: 12px 16px;
            border: 2px solid #E0F2FE;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            background: #FDFEFF;
            color: #1E2F3F;
        }

        .search-box:focus, .filter-select:focus {
            outline: none;
            border-color: #3B82F6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .quote-btn {
            background: linear-gradient(135deg, #FB923C 0%, #F59E0B 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(251, 146, 60, 0.3);
        }

        .quote-btn:hover {
            background: linear-gradient(135deg, #F59E0B 0%, #FB923C 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(251, 146, 60, 0.4);
        }

        .quote-btn:disabled {
            background: #B8C5D1;
            cursor: not-allowed;
            transform: none;
        }

        .products-table {
            background: #FDFEFF;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(30, 47, 63, 0.08);
            overflow: hidden;
            margin-bottom: 30px;
            border: 1px solid #E0F2FE;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        th {
            background: #5B7FA8;
            color: white;
            padding: 15px 10px;
            text-align: left;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 2px solid #7DA3CA;
        }

        th:first-child {
            width: 50px;
            text-align: center;
        }

        td {
            padding: 12px 10px;
            border-bottom: 1px solid #eee;
            vertical-align: top;
        }

        td:first-child {
            text-align: center;
            width: 50px;
        }

        tr:hover {
            background-color: #F0F9FF;
        }

        tr.selected {
            background-color: #E0F2FE;
        }

        .checkbox-cell {
            text-align: center;
        }

        .checkbox-cell input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .type-badge {
            background: #5B7FA8;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            display: inline-block;
        }

        .price-cell {
            font-weight: bold;
            color: #F59E0B;
            text-align: right;
        }

        .dimension-cell {
            font-size: 0.9em;
            color: #6B7685;
        }

        .image-cell {
            width: 200px;
            text-align: center;
            padding: 12px;
        }

        .product-image-small {
            width: 140px;
            height: 140px;
            object-fit: contain;
            border-radius: 4px;
            border: 1px solid #E0F2FE;
            background: #FDFEFF;
        }

        .no-image-small {
            width: 140px;
            height: 140px;
            background: #F0F9FF;
            border: 1px solid #E0F2FE;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #1E2F3F;
            text-align: center;
        }

        .module-name-cell {
            max-width: 120px;
            word-wrap: break-word;
            white-space: normal;
            font-weight: bold;
        }

        .structure-cell {
            max-width: 120px;
            word-wrap: break-word;
            white-space: normal;
            font-size: 0.9em;
        }

        .function-cell {
            max-width: 120px;
            word-wrap: break-word;
            white-space: normal;
            font-size: 0.9em;
        }

        .note-cell {
            max-width: 100px;
            word-wrap: break-word;
            white-space: normal;
            font-size: 0.9em;
        }

        .quantity-cell {
            width: 80px;
            text-align: center;
            padding: 8px;
        }

        .quantity-input {
            width: 60px;
            padding: 4px;
            border: 1px solid #E0F2FE;
            border-radius: 3px;
            text-align: center;
            font-size: 0.9em;
            background: #FDFEFF;
            color: #1E2F3F;
        }

        .quantity-input:disabled {
            background: #F0F9FF;
            color: #6B7685;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #6B7685;
        }

        .quote-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .quote-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .customer-info {
            margin: 20px 0;
            padding: 15px;
            background-color: #F0F9FF;
            border-radius: 8px;
            border-left: 4px solid #3B82F6;
        }

        .customer-info h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 16px;
        }

        .customer-fields {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .field-group {
            display: flex;
            flex-direction: column;
        }

        .field-group label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #5A6B78;
        }

        .field-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .field-group input:focus {
            outline: none;
            border-color: #3B82F6;
            box-shadow: 0 0 0 2px rgba(59,130,246,0.25);
        }

        .quote-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #1E2F3F;
            padding-bottom: 20px;
        }

        .quote-header h2 {
            color: #1E2F3F;
            font-size: 2em;
            margin-bottom: 10px;
        }

        .quote-items {
            margin-bottom: 30px;
        }

        .quote-item {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr 1fr;
            gap: 15px;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        .quote-item:last-child {
            border-bottom: none;
        }

        .quote-total {
            background: #F0F9FF;
            padding: 20px;
            border-radius: 8px;
            text-align: right;
            margin-bottom: 20px;
            border: 1px solid #E0F2FE;
        }

        .total-amount {
            font-size: 1.5em;
            font-weight: bold;
            color: #F59E0B;
        }

        .quote-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #FB923C 0%, #F59E0B 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(251, 146, 60, 0.3);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #F59E0B 0%, #FB923C 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(251, 146, 60, 0.4);
        }

        .btn-secondary {
            background: #3B82F6;
            color: white;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
        }

        .btn-secondary:hover {
            background: #2563EB;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .close-modal:hover {
            color: #333;
        }

        .selected-products-box {
            background: linear-gradient(135deg, #4F7396 0%, #6B91B8 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(79, 115, 150, 0.2);
            display: block;
        }

        .selected-products-box.show {
            display: block;
        }

        .selected-box-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .selected-box-title {
            font-size: 1.2em;
            font-weight: bold;
        }

        .clear-all-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .clear-all-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .selected-items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            background: #FFFFFF;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #3B82F6;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.1);
            margin-bottom: 20px;
        }

        .selected-item {
            background: #E0F2FE;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 2px solid #3B82F6;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
        }

        .selected-item-info {
            flex: 1;
        }

        .selected-item-name {
            font-weight: bold;
            margin-bottom: 4px;
            color: #1E2F3F;
        }

        .selected-item-details {
            font-size: 0.85em;
            color: #3B82F6;
            font-weight: 500;
        }

        .remove-item-btn {
            background: #FB923C;
            color: white;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(251, 146, 60, 0.3);
        }

        .remove-item-btn:hover {
            background: #F59E0B;
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(251, 146, 60, 0.4);
        }

        /* Custom Products Styles */
        .custom-products-box {
            background: #4F7396;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(79, 115, 150, 0.2);
            border: 1px solid #6B91B8;
        }

        .custom-box-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .custom-box-title {
            font-size: 1.2em;
            font-weight: bold;
        }

        .add-custom-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .add-custom-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .custom-products-container {
            display: grid;
            gap: 10px;
        }

        .custom-product-row {
            background: rgba(255,255,255,0.1);
            padding: 12px;
            border-radius: 6px;
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 12px;
            align-items: center;
        }

        .custom-product-inputs {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 10px;
        }

        .custom-product-inputs input {
            padding: 8px 12px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 4px;
            background: rgba(255,255,255,0.9);
            color: #333;
            font-size: 0.9em;
        }

        .custom-product-inputs input::placeholder {
            color: #666;
        }

        .custom-product-price {
            color: white;
            font-weight: bold;
            font-size: 0.95em;
        }

        .remove-custom-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .remove-custom-btn:hover {
            background: rgba(255,255,255,0.4);
        }

        /* Success and Warning States */
        .success-message {
            background: #27AE60;
            color: white;
            padding: 12px 16px;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: bold;
        }

        .warning-message {
            background: #F39C12;
            color: white;
            padding: 12px 16px;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: bold;
        }

        .error-message {
            background: #E74C3C;
            color: white;
            padding: 12px 16px;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: bold;
        }

        .info-message {
            background: #3498DB;
            color: white;
            padding: 12px 16px;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .logo {
                height: 50px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .controls {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .custom-product-row {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .custom-product-inputs {
                grid-template-columns: 1fr;
            }
            
            table {
                font-size: 12px;
            }
            
            th, td {
                padding: 8px 5px;
            }
            
            .quote-item {
                grid-template-columns: 1fr;
                gap: 10px;
                text-align: center;
            }
            
            .selected-items-grid {
                grid-template-columns: 1fr;
            }
            
            .image-cell {
                width: 100px;
            }
            
            .product-image-small {
                width: 70px;
                height: 70px;
            }
            
            .no-image-small {
                width: 70px;
                height: 70px;
                font-size: 8px;
            }
            
            .module-name-cell {
                max-width: 80px;
            }
            
            .structure-cell, .function-cell {
                max-width: 100px;
            }
            
            .note-cell {
                max-width: 80px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <img src="Logo.png" alt="SANKO Logo" class="logo" />
                <div class="header-text">
                    <h1>SANKO</h1>
                    <div class="subtitle">Tủ bếp Inox hệ Module</div>
                </div>
            </div>
        </header>

        <div class="controls">
            <input type="text" id="searchBox" class="search-box" placeholder="🔍 Tìm kiếm module..." />

            <select id="filterSelect" class="filter-select">
                <option value="">Tất cả loại module</option>
            </select>

            <div style="display: flex; gap: 10px;">
                <button id="refreshDataBtn" class="btn btn-secondary" onclick="refreshData()" title="Tải lại dữ liệu từ Google Drive">
                    🔄 Refresh
                </button>
                <button id="createQuoteBtn" class="quote-btn" disabled>
                    📄 Tạo báo giá (<span id="selectedCount">0</span>)
                </button>
            </div>
        </div>

        <!-- Selected Products Box -->
        <div id="selectedProductsBox" class="selected-products-box">
            <div class="selected-box-header">
                <div class="selected-box-title">
                    📋 Sản phẩm đã chọn (<span id="selectedCountInBox">0</span>)
                </div>
                <button class="clear-all-btn" onclick="clearAllSelected()">🗑️ Xóa tất cả</button>
            </div>
            <div id="selectedItemsGrid" class="selected-items-grid">
                <!-- Selected items will appear here -->
            </div>
        </div>

        <!-- Custom Products Section -->
        <div id="customProductsBox" class="custom-products-box">
            <div class="custom-box-header">
                <div class="custom-box-title">
                    ✏️ Sản phẩm tự định nghĩa
                </div>
                <button class="add-custom-btn" onclick="addCustomProduct()">➕ Thêm sản phẩm</button>
            </div>
            <div id="customProductsContainer" class="custom-products-container">
                <!-- Custom products will appear here -->
            </div>
        </div>

        <div id="loadingMessage" class="loading" style="display: none;">
            Đang tải dữ liệu...
        </div>

        <div class="products-table">
            <div class="table-container">
                <table id="productsTable">
                    <thead>
                        <tr>
                            <th>
                                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" title="Chọn tất cả" />
                            </th>
                            <th>SỐ LƯỢNG</th>
                            <th>HÌNH ẢNH</th>
                            <th>LOẠI MODULE</th>
                            <th>TÊN MODULE</th>
                            <th>DÀI</th>
                            <th>RỘNG</th>
                            <th>CAO</th>
                            <th>CẤU TẠO/ KẾT CẤU</th>
                            <th>CÔNG NĂNG KHUYẾN CÁO</th>
                            <th>LƯU Ý</th>
                            <th>GIÁ BÁN</th>
                        </tr>
                    </thead>
                    <tbody id="productsTableBody">
                        <!-- Products will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Quote Modal -->
    <div id="quoteModal" class="quote-modal">
        <div class="quote-content">
            <button class="close-modal" onclick="closeQuoteModal()">&times;</button>
            <div class="quote-header">
                <h2>BẢNG BÁO GIÁ</h2>
                <div id="quoteDate"></div>
            </div>
            
            <!-- Customer Information -->
            <div class="customer-info">
                <h3>Thông tin khách hàng:</h3>
                <div class="customer-fields">
                    <div class="field-group">
                        <label for="customerName">Tên khách hàng:</label>
                        <input type="text" id="customerName" placeholder="Nhập tên khách hàng">
                    </div>
                    <div class="field-group">
                        <label for="customerPhone">Số điện thoại:</label>
                        <input type="text" id="customerPhone" placeholder="Nhập số điện thoại">
                    </div>
                </div>
            </div>
            
            <div id="quoteItems" class="quote-items">
                <!-- Quote items will be generated here -->
            </div>
            <div class="quote-total">
                <div>Tổng tiền: <span id="quoteTotalAmount" class="total-amount">0 VND</span></div>
            </div>
            <div class="quote-actions">
                <button class="btn btn-primary" onclick="exportToPDF()">📄 Xuất PDF</button>
                <button class="btn btn-primary" onclick="exportToExcel()" style="background: #28a745;">📊 Xuất Excel</button>
                <button class="btn btn-secondary" onclick="closeQuoteModal()">Đóng</button>
            </div>
        </div>
    </div>

    <!-- Include PDFMake for better text copying -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <!-- Include SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        // Configuration for Google Sheets API (No CORS issues!)
        const GOOGLE_SHEETS_CONFIG = {
            // Google Sheets ID (từ URL của Google Sheets)
            SHEET_ID: '1Z7TGYfXhcY28Obc2oLpp39MgfaOJQGAPq1_jdy2vE5U', // Google Sheets native format - đã convert
            API_KEY: 'AIzaSyC5cCJ47c7mSJSO2cRxplHGt4zrDZwFbN0', // Google API Key
            RANGE: 'TTSP!A2:J', // Sheet name là "TTSP", lấy từ hàng 2 (bỏ header), cột A đến J
            IMAGES_FOLDER_ID: '1Bta6BA18DvI1VynXX7SluCb7ZNkSr70k', // ID của folder chứa hình ảnh
            IMAGES_BASE_URL: 'https://lh3.googleusercontent.com/d/',
            // Cache for image IDs (will be populated automatically)
            IMAGE_IDS_CACHE: {},
            CACHE_EXPIRY: 3600000 // 1 hour in milliseconds
        };

        let allProductsData = [];
        let filteredProductsData = [];
        let selectedProducts = new Map(); // Changed to Map to store {id: quantity}
        let customProducts = [];
        let customProductIdCounter = 1;

        // Function to convert Google Sheets data to products array
        function convertSheetsToProducts(sheetsData) {
            const products = [];
            
            // Bỏ qua hàng đầu (header) nếu có
            const dataRows = sheetsData.values || [];
            
            dataRows.forEach((row, index) => {
                // Kiểm tra xem hàng có dữ liệu không
                if (row.length >= 3 && row[2]) { // Cần ít nhất có TÊN MODULE
                    const product = {
                        id: parseInt(row[0]) || (index + 1), // STT hoặc auto increment
                        type: row[1] || 'CLASSIC', // LOẠI MODULE
                        name: row[2] || '', // TÊN MODULE
                        length: parseInt(row[3]) || 0, // DÀI
                        width: parseInt(row[4]) || 0, // RỘNG  
                        height: parseInt(row[5]) || 0, // CAO
                        structure: row[6] || '', // CẤU TẠO/ KẾT CẤU
                        function: row[7] || '', // CÔNG NĂNG KHUYẾN CÁO
                        note: row[8] || '', // LƯU Ý
                        price: parseInt(row[9]) || 0 // GIÁ BÁN
                    };
                    products.push(product);
                }
            });
            
            return products;
        }

        async function loadProductsData() {
            document.getElementById('loadingMessage').style.display = 'block';
            document.getElementById('loadingMessage').textContent = 'Đang tải dữ liệu từ Google Sheets...';
            
            const sheetsUrl = `https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_SHEETS_CONFIG.SHEET_ID}/values/${GOOGLE_SHEETS_CONFIG.RANGE}?key=${GOOGLE_SHEETS_CONFIG.API_KEY}`;
            const response = await fetch(sheetsUrl);
            const sheetsData = await response.json();
            const productsData = convertSheetsToProducts(sheetsData);
            
            allProductsData = productsData;
            filteredProductsData = [...allProductsData];
            populateFilters();
            displayProducts(filteredProductsData);
            updateUI();
            renderCustomProducts();
            document.getElementById('loadingMessage').style.display = 'none';
        }

        async function loadImageIdsWithAPI(useCache = true) {
            if (useCache) {
                const cached = localStorage.getItem('sanko_image_cache');
                if (cached) {
                    const cacheData = JSON.parse(cached);
                    if (Date.now() - cacheData.timestamp < GOOGLE_SHEETS_CONFIG.CACHE_EXPIRY) {
                        GOOGLE_SHEETS_CONFIG.IMAGE_IDS_CACHE = cacheData.imageIds;
                        return;
                    }
                }
            }
            
            const apiUrl = `https://www.googleapis.com/drive/v3/files?q='${GOOGLE_SHEETS_CONFIG.IMAGES_FOLDER_ID}'+in+parents&key=${GOOGLE_SHEETS_CONFIG.API_KEY}&fields=files(id,name)`;
            const response = await fetch(apiUrl);
            
            if (response.ok) {
                const result = await response.json();
                if (result.files) {
                    result.files.forEach(file => {
                        const nameWithoutExt = file.name.replace(/\.[^/.]+$/, '');
                        GOOGLE_SHEETS_CONFIG.IMAGE_IDS_CACHE[nameWithoutExt] = file.id;
                    });
                    
                    if (useCache) {
                        localStorage.setItem('sanko_image_cache', JSON.stringify({
                            imageIds: GOOGLE_SHEETS_CONFIG.IMAGE_IDS_CACHE,
                            timestamp: Date.now()
                        }));
                    }
                }
            }
        }





        function findFileId(productName) {
            if (GOOGLE_SHEETS_CONFIG.IMAGE_IDS_CACHE[productName]) {
                return GOOGLE_SHEETS_CONFIG.IMAGE_IDS_CACHE[productName];
            }
            
            const extensions = ['jpg', 'jpeg', 'png', 'webp'];
            for (const ext of extensions) {
                const keyWithExt = `${productName}.${ext}`;
                if (GOOGLE_SHEETS_CONFIG.IMAGE_IDS_CACHE[keyWithExt]) {
                    return GOOGLE_SHEETS_CONFIG.IMAGE_IDS_CACHE[keyWithExt];
                }
            }
            
            return '';
        }

        // Function to get image URL from Google Drive
        function getImageUrl(productName, returnType = 'url') {
            const fileId = findFileId(productName);
            
            if (returnType === 'id') {
                return fileId;
            }
            
            if (fileId) {
                // Use Google Drive API v3 with API key for direct access
                return `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media&key=${GOOGLE_SHEETS_CONFIG.API_KEY}`;
            }
            
            return '';
        }


        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            // Load image IDs first
            await loadImageIdsWithAPI();
            // Then load products data
            await loadProductsData();
        });

        // Function to refresh data from Google Drive
        async function refreshData() {
            const refreshBtn = document.getElementById('refreshDataBtn');
            refreshBtn.disabled = true;
            refreshBtn.textContent = '🔄 Đang tải...';
            
            localStorage.removeItem('sanko_image_cache');
            GOOGLE_SHEETS_CONFIG.IMAGE_IDS_CACHE = {};
            await loadImageIdsWithAPI(false);
            await loadProductsData();
            refreshBtn.textContent = '✅ Đã cập nhật';
            
            setTimeout(() => {
                refreshBtn.textContent = '🔄 Refresh';
                refreshBtn.disabled = false;
            }, 2000);
        }

        // Advanced image loading with blob URL creation
        async function loadImageWithBlob(fileId, imgElement) {
            try {
                const urls = [
                    `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media&key=${GOOGLE_SHEETS_CONFIG.API_KEY}`,
                    `https://drive.google.com/uc?export=view&id=${fileId}`,
                    `https://lh3.googleusercontent.com/d/${fileId}`
                ];
                
                for (const url of urls) {
                    try {
                        const response = await fetch(url, {
                            method: 'GET',
                            mode: 'cors',
                            cache: 'force-cache'
                        });
                        
                        if (response.ok) {
                            const blob = await response.blob();
                            const objectURL = URL.createObjectURL(blob);
                            imgElement.src = objectURL;
                            
                            // Clean up object URL after image loads
                            imgElement.onload = () => {
                                URL.revokeObjectURL(objectURL);
                            };
                            
                            return true;
                        }
                    } catch (fetchError) {
                        continue;
                    }
                }
                return false;
            } catch (error) {
                return false;
            }
        }

        // Handle image loading errors with multiple fallback URLs
        function handleImageError(img) {
            const productName = img.getAttribute('data-product-name');
            const fileId = getImageUrl(productName, 'id');
            
            if (!fileId) {
                img.onerror = null;
                img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iI2Y1ZjVmNSIvPjx0ZXh0IHg9IjUwIiB5PSI1MCIgZm9udC1zaXplPSIxMCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkzhu5Fi dOG6o2k8L3RleHQ+PC9zdmc+';
                return;
            }
            
            if (!img.retryCount) img.retryCount = 0;
            img.retryCount++;
            
            // Try blob loading first (most reliable)
            if (img.retryCount === 1) {
                loadImageWithBlob(fileId, img).then(success => {
                    if (!success) {
                        handleImageError(img); // Try next fallback
                    }
                });
                return;
            }
            
            const fallbackUrls = [
                `https://drive.google.com/uc?export=view&id=${fileId}`,
                `https://lh3.googleusercontent.com/d/${fileId}`,
                `https://drive.google.com/thumbnail?id=${fileId}&sz=w400`,
                `https://docs.google.com/uc?export=download&id=${fileId}`
            ];
            
            const fallbackIndex = img.retryCount - 2; // -2 because first retry is blob
            if (fallbackIndex < fallbackUrls.length) {
                img.src = fallbackUrls[fallbackIndex];
                return;
            }
            
            // All fallbacks failed
            img.onerror = null;
            img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iI2Y1ZjVmNSIvPjx0ZXh0IHg9IjUwIiB5PSI1MCIgZm9udC1zaXplPSIxMCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkzhu5Fi dOG6o2k8L3RleHQ+PC9zdmc+';
        }



        // Extract Excel generation logic


        // Event listeners
        document.getElementById('searchBox').addEventListener('input', displayProducts);
        document.getElementById('filterSelect').addEventListener('change', displayProducts);
        document.getElementById('createQuoteBtn').addEventListener('click', createQuote);

        function populateFilters() {
            const filterSelect = document.getElementById('filterSelect');
            const types = [...new Set(allProductsData.map(p => p.type))].filter(Boolean);
            
            // Clear existing options except "All"
            filterSelect.innerHTML = '<option value="">Tất cả loại module</option>';
            
            types.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                filterSelect.appendChild(option);
            });
        }

        function displayProducts(products = null) {
            const tbody = document.getElementById('productsTableBody');
            
            if (!products) {
                const searchTerm = document.getElementById('searchBox').value.toLowerCase();
                const filterType = document.getElementById('filterSelect').value;
                
                filteredProductsData = allProductsData.filter(product => {
                    const matchesSearch = !searchTerm || 
                        product.name.toLowerCase().includes(searchTerm) ||
                        product.type.toLowerCase().includes(searchTerm) ||
                        product.structure.toLowerCase().includes(searchTerm) ||
                        product.function.toLowerCase().includes(searchTerm);
                        
                    const matchesFilter = !filterType || product.type === filterType;
                    return matchesSearch && matchesFilter;
                });
                
                products = filteredProductsData;
            }
            
            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" style="text-align: center; padding: 50px;">Không tìm thấy sản phẩm nào.</td></tr>';
                updateUI();
                return;
            }

            tbody.innerHTML = products.map(product => `
                <tr class="${selectedProducts.has(product.id) ? 'selected' : ''}" id="row-${product.id}">
                    <td class="checkbox-cell">
                        <input type="checkbox" 
                               ${selectedProducts.has(product.id) ? 'checked' : ''}
                               data-product-id="${product.id}"
                               onchange="toggleProduct(this.dataset.productId)" />
                    </td>
                    <td class="quantity-cell">
                        <input type="number" 
                               class="quantity-input"
                               min="1" 
                               max="999"
                               value="${selectedProducts.get(product.id) || 1}"
                               ${!selectedProducts.has(product.id) ? 'disabled' : ''}
                               onchange="updateQuantity(${product.id}, this.value)" />
                    </td>
                    <td class="image-cell">
                        <img src="${getImageUrl(product.name) || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iI2Y1ZjVmNSIvPjx0ZXh0IHg9IjUwIiB5PSI1MCIgZm9udC1zaXplPSIxMiIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5vIEltYWdlPC90ZXh0Pjwvc3ZnPg=='}" 
                             alt="${product.name}"
                             class="product-image-small" 
                             data-product-name="${product.name}"
                             onerror="handleImageError(this)" />
                    </td>
                    <td><span class="type-badge">${product.type}</span></td>
                    <td class="module-name-cell">${product.name}</td>
                    <td class="dimension-cell">${product.length || '-'}</td>
                    <td class="dimension-cell">${product.width || '-'}</td>
                    <td class="dimension-cell">${product.height || '-'}</td>
                    <td class="structure-cell">${product.structure || '-'}</td>
                    <td class="function-cell">${product.function || '-'}</td>
                    <td class="note-cell">${product.note || '-'}</td>
                    <td class="price-cell">${formatPrice(product.price)}</td>
                </tr>
            `).join('');
            
            updateUI();
        }

// Unified UI update function
        function updateUI() {
            // Update counts and button state
            const count = selectedProducts.size;
            const validCustomProducts = customProducts.filter(p => p.name.trim() && p.price > 0);
            const validCustomProductsCount = validCustomProducts.length;
            const totalQuantity = Array.from(selectedProducts.values()).reduce((sum, qty) => sum + qty, 0);
            const totalItems = count + validCustomProductsCount;
            
            document.getElementById('selectedCount').textContent = totalQuantity + validCustomProductsCount;
            document.getElementById('selectedCountInBox').textContent = count;
            document.getElementById('createQuoteBtn').disabled = totalItems === 0;
            
            // Update select all checkbox
            const selectAllCheckbox = document.getElementById('selectAll');
            const visibleProductIds = filteredProductsData.map(p => p.id);
            const selectedVisibleProducts = visibleProductIds.filter(id => selectedProducts.has(id));
            
            if (selectedVisibleProducts.length === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            } else if (selectedVisibleProducts.length === visibleProductIds.length) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            }
            
            // Update selected products display
            const selectedItemsGrid = document.getElementById('selectedItemsGrid');
            const selectedItems = allProductsData.filter(p => selectedProducts.has(p.id));
            
            if (selectedItems.length === 0) {
                selectedItemsGrid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 30px; color: #6B7685; font-style: italic; background: #F0F9FF; border: 2px dashed #E0F2FE; border-radius: 8px;">Chưa có sản phẩm nào được chọn</div>';
            } else {
                selectedItemsGrid.innerHTML = selectedItems.map(item => {
                    const quantity = selectedProducts.get(item.id) || 1;
                    return `
                    <div class="selected-item" id="selected-item-${item.id}">
                        <div class="selected-item-info">
                            <div class="selected-item-name">${item.name} (x${quantity})</div>
                            <div class="selected-item-details">
                                ${item.type} - ${formatPrice(item.price * quantity)} VND
                            </div>
                        </div>
                        <button class="remove-item-btn" onclick="removeSelectedItem(${item.id})" title="Xóa sản phẩm">
                            ×
                        </button>
                    </div>`;
                }).join('');
            }
        }

        // Consolidated selection management
        function updateSelection(productId, action, quantity = 1) {
            productId = parseInt(productId);
            quantity = Math.max(1, Math.min(999, parseInt(quantity) || 1));
            
            switch (action) {
                case 'toggle':
                    if (selectedProducts.has(productId)) {
                        selectedProducts.delete(productId);
                    } else {
                        selectedProducts.set(productId, quantity);
                    }
                    displayProducts(filteredProductsData);
                    break;
                case 'setQuantity':
                    if (selectedProducts.has(productId)) {
                        selectedProducts.set(productId, quantity);
                    }
                    break;
                case 'remove':
                    selectedProducts.delete(productId);
                    displayProducts(filteredProductsData);
                    break;
                case 'clear':
                    selectedProducts.clear();
                    displayProducts(filteredProductsData);
                    break;
            }
            updateUI();
        }        // Wrapper functions for compatibility
        function toggleProduct(productId) { updateSelection(productId, 'toggle'); }
        function updateQuantity(productId, quantity) { updateSelection(productId, 'setQuantity', quantity); }
        function removeSelectedItem(productId) { updateSelection(productId, 'remove'); }
        function clearAllSelected() { updateSelection(null, 'clear'); }

        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAll');
            const visibleProductIds = filteredProductsData.map(p => p.id);
            
            if (selectAllCheckbox.checked) {
                visibleProductIds.forEach(id => selectedProducts.set(id, 1));
            } else {
                visibleProductIds.forEach(id => selectedProducts.delete(id));
            }
            
            displayProducts(filteredProductsData);
            updateUI();
        }

        // Unified export preparation function
        function prepareExportData() {
            const allSelectedItems = getAllSelectedItems();
            if (allSelectedItems.length === 0) return null;
            
            return {
                items: allSelectedItems,
                total: calculateTotal(allSelectedItems),
                customerName: document.getElementById('customerName').value || '',
                customerPhone: document.getElementById('customerPhone').value || ''
            };
        }

        function createQuote() {
            const exportData = prepareExportData();
            if (!exportData) return;

            document.getElementById('quoteDate').textContent = 
                'Ngày: ' + new Date().toLocaleDateString('vi-VN');

            document.getElementById('quoteItems').innerHTML = generateQuoteItemsHTML(exportData.items);
            document.getElementById('quoteTotalAmount').textContent = formatPrice(exportData.total) + ' VND';
            document.getElementById('quoteModal').style.display = 'block';
        }

        function generateQuoteItemsHTML(items) {
            return items.map((item, index) => `
                <div class="quote-item">
                    <div style="font-weight: bold;">${index + 1}</div>
                    <div>
                        <div style="font-weight: bold; margin-bottom: 5px;">${item.name}</div>
                        <div style="font-size: 0.9em; color: #666;">
                            ${item.isCustom ? 'Sản phẩm tự định nghĩa' : 
                                item.type + ' - ' + (item.length ? item.length + 'x' + item.width + 'x' + item.height + 'mm' : 'N/A')
                            }
                        </div>
                    </div>
                    <div style="text-align: center;">${item.quantity}</div>
                    <div style="text-align: right; font-weight: bold; color: #95A5A6;">
                        ${formatPrice(item.subtotal || (item.price * item.quantity))} VND
                    </div>
                </div>
            `).join('');
        }

        function closeQuoteModal() {
            document.getElementById('quoteModal').style.display = 'none';
        }

        async function exportToPDF() {
            const exportData = prepareExportData();
            if (exportData) await generateUnifiedDocument(exportData, 'pdf');
        }

        async function exportToExcel() {
            const exportData = prepareExportData();
            if (exportData) await generateUnifiedDocument(exportData, 'excel');
        }

        // Helper function to convert logo to base64
        async function getLogoBase64() {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = this.width;
                    canvas.height = this.height;
                    ctx.drawImage(this, 0, 0);
                    const dataURL = canvas.toDataURL('image/png');
                    resolve(dataURL);
                };
                img.onerror = () => resolve(''); // Fallback nếu không load được logo
                img.src = 'Logo.png';
            });
        }

        // Helper function to convert image URL to base64 for PDFMake
        async function convertImageUrlToBase64(imageUrl) {
            return new Promise((resolve) => {
                if (!imageUrl || imageUrl.includes('data:image/svg')) {
                    resolve(null);
                    return;
                }
                
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = this.width;
                    canvas.height = this.height;
                    ctx.drawImage(this, 0, 0);
                    resolve(canvas.toDataURL('image/jpeg', 0.8));
                };
                img.onerror = () => resolve(null);
                img.src = imageUrl;
            });
        }

        // Helper function to load all product images as base64
        async function loadProductImages(items) {
            const imagePromises = items.map(async (item) => {
                const imageUrl = getImageUrl(item.name);
                const base64 = await convertImageUrlToBase64(imageUrl);
                return {
                    name: item.name,
                    url: imageUrl,
                    base64: base64
                };
            });
            
            const results = await Promise.all(imagePromises);
            const imageMap = {};
            results.forEach(result => {
                imageMap[result.name] = {
                    url: result.url,
                    base64: result.base64
                };
            });
            return imageMap;
        }

        // Unified Document Generation - Same layout for both PDF and Excel
        async function generateUnifiedDocument(exportData, format = 'pdf') {
            const { items, total, customerName, customerPhone } = exportData;
            
            // Convert logo to base64 (same for both formats)
            const logoBase64 = await getLogoBase64();
            
            // Load product images as base64 for PDF (Excel will use URLs)
            const productImages = format === 'pdf' ? await loadProductImages(items) : null;
            
            // SHARED docDefinition for both PDF and Excel
            const docDefinition = {
                pageSize: 'A4',
                pageMargins: [40, 120, 40, 60],
                
                // Header section (SAME for both)
                header: {
                    margin: [40, 15, 40, 15],
                    table: {
                        widths: ['auto', '*'],
                        body: [
                            [
                                logoBase64 ? { image: logoBase64, width: 120, fit: [120, 80] } : { text: 'SANKO', style: 'logoText' },
                                {
                                    stack: [
                                        { text: 'BẢNG BÁO GIÁ', style: 'title' },
                                        { text: 'SANKO - Tủ bếp Inox hệ Module', style: 'subtitle' },
                                        { text: 'Hotline: 0844 803 777', style: 'hotline' }
                                    ],
                                    alignment: 'center'
                                }
                            ]
                        ]
                    },
                    layout: 'noBorders'
                },
                
                content: [
                    // Date (SAME)
                    {
                        text: `Ngày lập: ${new Date().toLocaleDateString('vi-VN')}`,
                        alignment: 'right',
                        margin: [0, 0, 0, 20]
                    },
                    
                    // Customer info (SAME)
                    ...(customerName || customerPhone ? [{
                        table: {
                            widths: ['*'],
                            body: [
                                [{
                                    stack: [
                                        { text: 'THÔNG TIN KHÁCH HÀNG', style: 'sectionHeader' },
                                        ...(customerName ? [{ text: `Tên khách hàng: ${customerName}`, margin: [0, 5, 0, 0] }] : []),
                                        ...(customerPhone ? [{ text: `Số điện thoại: ${customerPhone}`, margin: [0, 5, 0, 0] }] : [])
                                    ],
                                    fillColor: '#F7F9FB',
                                    margin: [10, 10, 10, 10]
                                }]
                            ]
                        },
                        layout: {
                            defaultBorder: false,
                            fillColor: '#F7F9FB'
                        },
                        margin: [0, 0, 0, 20]
                    }] : []),
                    
                    // Products table (ENHANCED for Excel compatibility)
                    {
                        table: {
                            headerRows: 1,
                            widths: ['auto', '*', 'auto', 'auto', 'auto', 'auto', 'auto', 'auto'],
                            body: [
                                // Header (UPDATED with image link column)
                                [
                                    { text: 'STT', style: 'tableHeader' },
                                    { text: 'TÊN MODULE', style: 'tableHeader' },
                                    { text: 'THÔNG SỐ', style: 'tableHeader' },
                                    { text: 'HÌNH ẢNH', style: 'tableHeader' },
                                    { text: 'LINK', style: 'tableHeader' },
                                    { text: 'GIÁ', style: 'tableHeader' },
                                    { text: 'SL', style: 'tableHeader' },
                                    { text: 'THÀNH TIỀN', style: 'tableHeader' }
                                ],
                                // Data rows (ENHANCED with images)
                                ...items.map((item, index) => {
                                    const itemSubtotal = item.subtotal || (item.price * item.quantity);
                                    const dimensions = !item.isCustom ? 
                                        `${item.length || 'N/A'}×${item.width || 'N/A'}×${item.height || 'N/A'}mm` : 
                                        'Tùy chỉnh';
                                    
                                    // Get image data for this product
                                    const imageUrl = getImageUrl(item.name);
                                    const hasImage = imageUrl && !imageUrl.includes('data:image/svg');
                                    const imageBase64 = format === 'pdf' && productImages ? productImages[item.name]?.base64 : null;
                                    
                                    // Create direct viewable link instead of API URL
                                    const fileId = getImageUrl(item.name, 'id');
                                    const viewableImageUrl = fileId ? `https://drive.google.com/file/d/${fileId}/view?usp=sharing` : imageUrl;
                                    
                                    return [
                                        { text: (index + 1).toString(), style: 'tableCell', alignment: 'center' },
                                        { 
                                            // Reduced info for Excel due to more columns
                                            text: format === 'excel' ? 
                                                `${item.name}\\n${item.type || 'Tùy chỉnh'}` :
                                                item.name,
                                            style: 'tableCellBold' 
                                        },
                                        { text: dimensions, style: 'tableCell', alignment: 'center' },
                                        // IMAGE COLUMN - Different handling for PDF vs Excel
                                        format === 'pdf' && imageBase64 ? 
                                            { image: imageBase64, width: 50, height: 50, alignment: 'center' } :
                                            format === 'pdf' ? 
                                                { text: 'Không có hình', style: 'tableCell', alignment: 'center', fontSize: 8 } :
                                                { text: hasImage ? 'Có hình' : 'Không có', style: 'tableCell', alignment: 'center' },
                                        // IMAGE LINK COLUMN - Show clickable URL
                                        hasImage ? (
                                            format === 'pdf' ? 
                                                {
                                                    text: 'Xem hình ảnh',
                                                    link: viewableImageUrl,
                                                    style: 'tableCellLink',
                                                    alignment: 'left',
                                                    fontSize: 8,
                                                    color: '#0066CC',
                                                    decoration: 'underline'
                                                } :
                                                { 
                                                    text: viewableImageUrl,
                                                    style: 'tableCell', 
                                                    alignment: 'left',
                                                    fontSize: 7,
                                                    color: '#0066CC'
                                                }
                                        ) : {
                                            text: 'Không có link',
                                            style: 'tableCell', 
                                            alignment: 'left',
                                            fontSize: 7,
                                            color: '#999999'
                                        },
                                        { text: formatPrice(item.price), style: 'tableCell', alignment: 'right' },
                                        { text: item.quantity.toString(), style: 'tableCell', alignment: 'center' },
                                        { text: formatPrice(itemSubtotal), style: 'tableCellBold', alignment: 'right' }
                                    ];
                                })
                            ]
                        },
                        layout: {
                            fillColor: function (rowIndex) {
                                return (rowIndex === 0) ? '#2B3E50' : (rowIndex % 2 === 0 ? '#F7F9FB' : null);
                            }
                        }
                    },
                    
                    // Total section (SAME)
                    {
                        table: {
                            widths: ['*', 'auto'],
                            body: [
                                [
                                    '',
                                    {
                                        text: `TỔNG TIỀN: ${formatPrice(total)} VND`,
                                        style: 'total',
                                        fillColor: '#2B3E50',
                                        color: 'white',
                                        margin: [10, 10, 10, 10]
                                    }
                                ]
                            ]
                        },
                        layout: 'noBorders',
                        margin: [0, 20, 0, 20]
                    }
                ],
                
                // Footer (SAME)
                footer: {
                    margin: [40, 20, 40, 20],
                    stack: [
                        { canvas: [{ type: 'line', x1: 0, y1: 5, x2: 515, y2: 5, lineWidth: 1, lineColor: '#eee' }] },
                        { text: 'Cảm ơn quý khách đã tin tưởng sản phẩm SANKO!', style: 'footer', margin: [0, 10, 0, 5] },
                        { text: 'Mọi thắc mắc xin liên hệ: 0844 803 777', style: 'footer' }
                    ]
                },
                
                // Styles definition (SAME)
                styles: {
                    logoText: {
                        fontSize: 16,
                        bold: true,
                        color: '#2B3E50'
                    },
                    title: {
                        fontSize: 20,
                        bold: true,
                        color: '#2B3E50',
                        margin: [0, 0, 0, 5]
                    },
                    subtitle: {
                        fontSize: 14,
                        color: '#666666',
                        margin: [0, 0, 0, 5]
                    },
                    hotline: {
                        fontSize: 12,
                        bold: true,
                        color: '#D35400'
                    },
                    sectionHeader: {
                        fontSize: 14,
                        bold: true,
                        color: '#2B3E50',
                        margin: [0, 0, 0, 10]
                    },
                    tableHeader: {
                        fontSize: 10,
                        bold: true,
                        color: 'white',
                        fillColor: '#2B3E50',
                        margin: [5, 5, 5, 5]
                    },
                    tableCell: {
                        fontSize: 9,
                        margin: [5, 5, 5, 5]
                    },
                    tableCellBold: {
                        fontSize: 9,
                        bold: true,
                        margin: [5, 5, 5, 5]
                    },
                    tableCellLink: {
                        fontSize: 8,
                        margin: [5, 5, 5, 5],
                        color: '#0066CC',
                        decoration: 'underline'
                    },
                    total: {
                        fontSize: 16,
                        bold: true,
                        alignment: 'right'
                    },
                    footer: {
                        fontSize: 10,
                        italics: true,
                        color: '#2B3E50',
                        alignment: 'center'
                    }
                }
            };
            
            // Generate filename
            const fileName = customerName ? 
                `bao-gia-sanko-${customerName.replace(/\\s+/g, '-').toLowerCase()}` : 
                'bao-gia-sanko';
            
            // Export based on format
            if (format === 'excel') {
                // Convert PDFMake docDefinition to Excel
                await convertPDFMakeToExcel(docDefinition, fileName + '.xlsx');
            } else {
                // Generate PDF (default)
                pdfMake.createPdf(docDefinition).download(fileName + '.pdf');
            }
        }

        // Helper function to convert PDFMake docDefinition to Excel format
        async function convertPDFMakeToExcel(docDefinition, fileName) {
            // Convert PDFMake structure to Excel-compatible data
            const wsData = [];
            
            // Add header info with logo placeholder (Excel doesn't support embedded images easily)
            wsData.push(['SANKO LOGO', '', '', '', 'BẢNG BÁO GIÁ']);
            wsData.push(['', '', '', '', 'SANKO - Tủ bếp Inox hệ Module']);
            wsData.push(['', '', '', '', 'Hotline: 0844 803 777']);
            wsData.push(['']);
            
            // Add date from content
            const dateContent = docDefinition.content.find(item => 
                typeof item === 'object' && item.text && item.text.includes('Ngày lập')
            );
            if (dateContent) {
                wsData.push([dateContent.text]);
            }
            wsData.push(['']);
            
            // Add customer info if exists
            const customerContent = docDefinition.content.find(item => 
                item.table && item.table.body && item.table.body[0][0].stack &&
                item.table.body[0][0].stack.some(s => s.text === 'THÔNG TIN KHÁCH HÀNG')
            );
            if (customerContent) {
                wsData.push(['THÔNG TIN KHÁCH HÀNG']);
                const customerStack = customerContent.table.body[0][0].stack;
                customerStack.forEach(item => {
                    if (item.text && (item.text.includes('Tên khách hàng') || item.text.includes('Số điện thoại'))) {
                        wsData.push([item.text]);
                    }
                });
                wsData.push(['']);
            }
            
            // Add products table from docDefinition
            const productsTable = docDefinition.content.find(item => 
                item.table && item.table.headerRows === 1
            );
            if (productsTable) {
                // Add headers
                const headers = productsTable.table.body[0].map(cell => cell.text);
                wsData.push(headers);
                
                // Add data rows
                productsTable.table.body.slice(1).forEach(row => {
                    const rowData = row.map(cell => {
                        if (typeof cell.text === 'string') {
                            return cell.text.replace(/\\n/g, ' '); // Convert newlines to spaces for Excel
                        }
                        return cell.text || '';
                    });
                    wsData.push(rowData);
                });
            }
            
            // Add total from docDefinition
            wsData.push(['']);
            const totalContent = docDefinition.content.find(item => 
                item.table && item.table.body && item.table.body[0][1] && 
                item.table.body[0][1].text && item.table.body[0][1].text.includes('TỔNG TIỀN')
            );
            if (totalContent) {
                wsData.push(['', '', '', '', '', '', '', totalContent.table.body[0][1].text]);
            }
            
            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            
            // Apply enhanced styling (colors should work now!)
            applyUnifiedExcelFormatting(ws, productsTable ? productsTable.table.body.length - 1 : 0, !!customerContent);
            
            // Add worksheet to workbook and export
            XLSX.utils.book_append_sheet(wb, ws, 'Báo giá SANKO');
            XLSX.writeFile(wb, fileName);
        }

        // Enhanced Excel formatting to match PDF styling
        function applyUnifiedExcelFormatting(ws, itemCount, hasCustomerInfo) {
            // Set column widths
            const colWidths = [
                { wch: 5 },  // STT
                { wch: 18 }, // TÊN MODULE (reduced from 25)
                { wch: 12 }, // THÔNG SỐ
                { wch: 15 }, // HÌNH ẢNH (increased from 12)
                { wch: 25 }, // LINK HÌNH ẢNH (new column)
                { wch: 12 }, // GIÁ
                { wch: 8 },  // SL
                { wch: 15 }  // THÀNH TIỀN
            ];
            ws['!cols'] = colWidths;
            
            // Calculate row positions
            let headerRowIndex = hasCustomerInfo ? 9 : 6;
            let dataStartRow = headerRowIndex + 1;
            let totalRowIndex = dataStartRow + itemCount + 1;
            
            // Helper function to get cell address
            const getCellAddr = (row, col) => XLSX.utils.encode_cell({ r: row, c: col });
            
            // CRITICAL: Use correct XLSX color format
            const colors = {
                darkBlue: "2B3E50",
                lightBlue: "E8F4FD", 
                mediumBlue: "34495E",
                orange: "D35400",
                lightGray: "F7F9FB",
                white: "FFFFFF",
                borderGray: "E0E0E0"
            };
            
            // Format logo area (A1:C3)
            for (let row = 0; row <= 2; row++) {
                for (let col = 0; col <= 2; col++) {
                    const cellAddr = getCellAddr(row, col);
                    if (!ws[cellAddr]) ws[cellAddr] = { v: row === 1 && col === 1 ? 'SANKO LOGO' : '' };
                    ws[cellAddr].s = {
                        font: { bold: true, sz: 14, color: { rgb: colors.darkBlue } },
                        fill: { fgColor: { rgb: colors.lightBlue } },
                        alignment: { horizontal: "center", vertical: "center" },
                        border: {
                            top: { style: "thick", color: { rgb: colors.darkBlue } },
                            bottom: { style: "thick", color: { rgb: colors.darkBlue } },
                            left: { style: "thick", color: { rgb: colors.darkBlue } },
                            right: { style: "thick", color: { rgb: colors.darkBlue } }
                        }
                    };
                }
            }
            
            // Format header section (E1:F3) 
            const headerTexts = ['BẢNG BÁO GIÁ', 'SANKO - Tủ bếp Inox hệ Module', 'Hotline: 0844 803 777'];
            const headerColors = [colors.darkBlue, colors.mediumBlue, colors.orange];
            
            for (let row = 0; row <= 2; row++) {
                for (let col = 4; col <= 5; col++) {
                    const cellAddr = getCellAddr(row, col);
                    if (!ws[cellAddr]) ws[cellAddr] = { v: col === 4 ? headerTexts[row] : '' };
                    ws[cellAddr].s = {
                        font: { bold: true, sz: row === 0 ? 18 : 12, color: { rgb: colors.white } },
                        fill: { fgColor: { rgb: headerColors[row] } },
                        alignment: { horizontal: "center", vertical: "center" }
                    };
                }
            }
            
            // Set merges
            if (!ws['!merges']) ws['!merges'] = [];
            ws['!merges'].push({ s: { r: 0, c: 0 }, e: { r: 2, c: 2 } }); // Logo area
            ws['!merges'].push({ s: { r: 0, c: 4 }, e: { r: 0, c: 7 } }); // Title (extended for 8 cols)
            ws['!merges'].push({ s: { r: 1, c: 4 }, e: { r: 1, c: 7 } }); // Subtitle  
            ws['!merges'].push({ s: { r: 2, c: 4 }, e: { r: 2, c: 7 } }); // Hotline
            
            // Format table headers with DARK BLUE background
            for (let col = 0; col < 8; col++) { // Updated to 8 columns
                const cellAddr = getCellAddr(headerRowIndex, col);
                if (!ws[cellAddr]) ws[cellAddr] = { v: '' };
                ws[cellAddr].s = {
                    font: { bold: true, sz: 11, color: { rgb: colors.white } },
                    fill: { fgColor: { rgb: colors.darkBlue } },
                    alignment: { horizontal: "center", vertical: "center" },
                    border: {
                        top: { style: "thin", color: { rgb: colors.white } },
                        bottom: { style: "thin", color: { rgb: colors.white } },
                        left: { style: "thin", color: { rgb: colors.white } },
                        right: { style: "thin", color: { rgb: colors.white } }
                    }
                };
            }
            
            // Format data rows with alternating colors
            for (let row = dataStartRow; row < dataStartRow + itemCount; row++) {
                const isEvenRow = (row - dataStartRow) % 2 === 0;
                const bgColor = isEvenRow ? colors.lightGray : colors.white;
                
                for (let col = 0; col < 8; col++) { // Updated to 8 columns
                    const cellAddr = getCellAddr(row, col);
                    if (!ws[cellAddr]) ws[cellAddr] = { v: '' };
                    
                    let style = {
                        fill: { fgColor: { rgb: bgColor } },
                        border: {
                            top: { style: "thin", color: { rgb: colors.borderGray } },
                            bottom: { style: "thin", color: { rgb: colors.borderGray } },
                            left: { style: "thin", color: { rgb: colors.borderGray } },
                            right: { style: "thin", color: { rgb: colors.borderGray } }
                        }
                    };
                    
                    // Column-specific formatting
                    if (col === 0) { // STT
                        style.alignment = { horizontal: "center" };
                    } else if (col === 3) { // HÌNH ẢNH column
                        style.alignment = { horizontal: "center" };
                        style.font = { sz: 8, color: { rgb: colors.darkBlue } };
                    } else if (col === 4) { // LINK HÌNH ẢNH column
                        style.alignment = { horizontal: "left" };
                        style.font = { sz: 8, color: { rgb: colors.orange } }; // Orange for links
                    } else if (col === 5 || col === 7) { // Price columns (moved due to new columns)
                        style.numFmt = "#,##0";
                        style.alignment = { horizontal: "right" };
                        style.font = { color: { rgb: colors.orange } };
                    } else if (col === 6) { // Quantity (moved due to new columns)
                        style.alignment = { horizontal: "center" };
                    }
                    
                    ws[cellAddr].s = style;
                }
            }
            
            // Format total row with DARK BLUE background
            for (let col = 6; col <= 7; col++) { // Updated positions for 8-column layout
                const cellAddr = getCellAddr(totalRowIndex, col);
                if (!ws[cellAddr]) ws[cellAddr] = { v: col === 6 ? 'TỔNG TIỀN:' : '' };
                ws[cellAddr].s = {
                    font: { bold: true, sz: 14, color: { rgb: colors.white } },
                    fill: { fgColor: { rgb: colors.darkBlue } },
                    alignment: { horizontal: col === 6 ? "center" : "right" },
                    numFmt: col === 7 ? "#,##0" : undefined,
                    border: {
                        top: { style: "thick", color: { rgb: colors.darkBlue } },
                        bottom: { style: "thick", color: { rgb: colors.darkBlue } },
                        left: { style: "thick", color: { rgb: colors.darkBlue } },
                        right: { style: "thick", color: { rgb: colors.darkBlue } }
                    }
                };
            }
            
            // Set row heights
            if (!ws['!rows']) ws['!rows'] = [];
            ws['!rows'][0] = { hpt: 30 }; // Header rows
            ws['!rows'][1] = { hpt: 25 };
            ws['!rows'][2] = { hpt: 25 };
            ws['!rows'][headerRowIndex] = { hpt: 25 }; // Table header 
            ws['!rows'][totalRowIndex] = { hpt: 25 }; // Total row
        }

        function formatPrice(price) {
            return new Intl.NumberFormat('vi-VN').format(price);
        }
        
        function getAllSelectedItems() {
            const selectedItems = [];
            selectedProducts.forEach((quantity, productId) => {
                const product = allProductsData.find(p => p.id == productId);
                if (product) {
                    selectedItems.push({
                        ...product,
                        quantity: quantity,
                        subtotal: product.price * quantity
                    });
                }
            });
            
            const validCustomProducts = customProducts.filter(p => p.name.trim() && p.price > 0);
            validCustomProducts.forEach(product => {
                product.quantity = 1;
                product.subtotal = product.price;
            });
            return [...selectedItems, ...validCustomProducts];
        }
        
        function calculateTotal(items) {
            return items.reduce((sum, item) => sum + (item.subtotal || (item.price * item.quantity)), 0);
        }

        function manageCustomProduct(action, customId = null, field = null, value = null) {
            switch (action) {
                case 'add':
                    const newCustomId = `custom_${customProductIdCounter++}`;
                    customProducts.push({
                        id: newCustomId,
                        name: '',
                        price: 0,
                        isCustom: true,
                        quantity: 1
                    });
                    break;
                case 'remove':
                    customProducts = customProducts.filter(p => p.id !== customId);
                    break;
                case 'update':
                    const product = customProducts.find(p => p.id === customId);
                    if (product) {
                        if (field === 'name') {
                            product.name = value;
                        } else if (field === 'price') {
                            product.price = parseFloat(value) || 0;
                        }
                    }
                    break;
            }
            renderCustomProducts();
            updateUI();
        }
        function addCustomProduct() {
            manageCustomProduct('add');
        }

        function removeCustomProduct(customId) {
            manageCustomProduct('remove', customId);
        }

        function updateCustomProduct(customId, field, value) {
            manageCustomProduct('update', customId, field, value);
        }

        function renderCustomProducts() {
            const container = document.getElementById('customProductsContainer');
            
            if (customProducts.length === 0) {
                container.innerHTML = '<div style="text-align: center; opacity: 0.7; font-style: italic;">Chưa có sản phẩm tự định nghĩa nào</div>';
                return;
            }

            container.innerHTML = customProducts.map(product => `
                <div class="custom-product-row">
                    <div class="custom-product-inputs">
                        <input 
                            type="text" 
                            placeholder="Tên sản phẩm..." 
                            value="${product.name}"
                            onchange="updateCustomProduct('${product.id}', 'name', this.value)"
                        />
                        <input 
                            type="number" 
                            placeholder="Giá tiền..." 
                            value="${product.price || ''}"
                            onchange="updateCustomProduct('${product.id}', 'price', this.value)"
                        />
                    </div>
                    <div class="custom-product-price">
                        ${product.price > 0 ? formatPrice(product.price) + ' VND' : 'Chưa có giá'}
                    </div>
                    <button class="remove-custom-btn" onclick="removeCustomProduct('${product.id}')">
                        ✕
                    </button>
                </div>
            `).join('');
        }

        window.onclick = function(event) {
            const modal = document.getElementById('quoteModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }
    </script>
</body>
</html>