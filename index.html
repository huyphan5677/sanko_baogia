<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tạo Báo Giá SANKO</title>
    <!-- Google Fonts for Vietnamese support -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #F7F9FB;
            color: #2C3E47;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #2B3E50 0%, #34495E 100%);
            color: white;
            padding: 30px;
            margin-bottom: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(43,62,80,0.2);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            position: relative;
        }

        .logo {
            height: 120px;
            width: auto;
            object-fit: contain;
            position: absolute;
            left: 20px;
        }

        .header-text {
            text-align: center;
            margin: 0;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .controls {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 20px;
            align-items: center;
        }

        .search-box, .filter-select {
            padding: 12px 16px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .search-box:focus, .filter-select:focus {
            outline: none;
            border-color: #2B3E50;
        }

        .quote-btn {
            background: #D35400;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .quote-btn:hover {
            background: #E67E22;
            transform: translateY(-1px);
        }

        .quote-btn:disabled {
            background: #B8C5D1;
            cursor: not-allowed;
            transform: none;
        }

        .products-table {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 30px;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        th {
            background: linear-gradient(135deg, #2B3E50 0%, #34495E 100%);
            color: white;
            padding: 15px 10px;
            text-align: left;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th:first-child {
            width: 50px;
            text-align: center;
        }

        td {
            padding: 12px 10px;
            border-bottom: 1px solid #eee;
            vertical-align: top;
        }

        td:first-child {
            text-align: center;
            width: 50px;
        }

        tr:hover {
            background-color: #F1F4F7;
        }

        tr.selected {
            background-color: #E8EDF2;
        }

        .checkbox-cell {
            text-align: center;
        }

        .checkbox-cell input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .type-badge {
            background: #2B3E50;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            display: inline-block;
        }

        .price-cell {
            font-weight: bold;
            color: #D35400;
            text-align: right;
        }

        .dimension-cell {
            font-size: 0.9em;
            color: #6B7685;
        }

        .image-cell {
            width: 200px;
            text-align: center;
            padding: 12px;
        }

        .product-image-small {
            width: 140px;
            height: 140px;
            object-fit: contain;
            border-radius: 4px;
            border: 1px solid #ddd;
            background: #f9f9f9;
        }

        .no-image-small {
            width: 140px;
            height: 140px;
            background: #F7F9FB;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #8A95A3;
            text-align: center;
        }

        .module-name-cell {
            max-width: 120px;
            word-wrap: break-word;
            white-space: normal;
            font-weight: bold;
        }

        .structure-cell {
            max-width: 120px;
            word-wrap: break-word;
            white-space: normal;
            font-size: 0.9em;
        }

        .function-cell {
            max-width: 120px;
            word-wrap: break-word;
            white-space: normal;
            font-size: 0.9em;
        }

        .note-cell {
            max-width: 100px;
            word-wrap: break-word;
            white-space: normal;
            font-size: 0.9em;
        }

        .quantity-cell {
            width: 80px;
            text-align: center;
            padding: 8px;
        }

        .quantity-input {
            width: 60px;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 3px;
            text-align: center;
            font-size: 0.9em;
        }

        .quantity-input:disabled {
            background: #F7F9FB;
            color: #8A95A3;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #6B7685;
        }

        .quote-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .quote-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .customer-info {
            margin: 20px 0;
            padding: 15px;
            background-color: #F7F9FB;
            border-radius: 8px;
            border-left: 4px solid #2B3E50;
        }

        .customer-info h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 16px;
        }

        .customer-fields {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .field-group {
            display: flex;
            flex-direction: column;
        }

        .field-group label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #5A6B78;
        }

        .field-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .field-group input:focus {
            outline: none;
            border-color: #2B3E50;
            box-shadow: 0 0 0 2px rgba(43,62,80,0.25);
        }

        .quote-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #2B3E50;
            padding-bottom: 20px;
        }

        .quote-header h2 {
            color: #2B3E50;
            font-size: 2em;
            margin-bottom: 10px;
        }

        .quote-items {
            margin-bottom: 30px;
        }

        .quote-item {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr 1fr;
            gap: 15px;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        .quote-item:last-child {
            border-bottom: none;
        }

        .quote-total {
            background: #F7F9FB;
            padding: 20px;
            border-radius: 8px;
            text-align: right;
            margin-bottom: 20px;
        }

        .total-amount {
            font-size: 1.5em;
            font-weight: bold;
            color: #D35400;
        }

        .quote-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #2B3E50;
            color: white;
        }

        .btn-primary:hover {
            background: #1A252F;
        }

        .btn-secondary {
            background: #34495E;
            color: white;
        }

        .btn-secondary:hover {
            background: #2B3E50;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .close-modal:hover {
            color: #333;
        }

        .selected-products-box {
            background: linear-gradient(135deg, #2B3E50 0%, #34495E 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
            display: block;
        }

        .selected-products-box.show {
            display: block;
        }

        .selected-box-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .selected-box-title {
            font-size: 1.2em;
            font-weight: bold;
        }

        .clear-all-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .clear-all-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .selected-items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
        }

        .selected-item {
            background: rgba(255,255,255,0.1);
            padding: 12px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .selected-item-info {
            flex: 1;
        }

        .selected-item-name {
            font-weight: bold;
            margin-bottom: 4px;
        }

        .selected-item-details {
            font-size: 0.85em;
            opacity: 0.9;
        }

        .remove-item-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .remove-item-btn:hover {
            background: rgba(255,255,255,0.4);
        }

        /* Custom Products Styles */
        .custom-products-box {
            background: linear-gradient(135deg, #5D6A75 0%, #485964 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(211, 84, 0, 0.3);
        }

        .custom-box-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .custom-box-title {
            font-size: 1.2em;
            font-weight: bold;
        }

        .add-custom-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .add-custom-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .custom-products-container {
            display: grid;
            gap: 10px;
        }

        .custom-product-row {
            background: rgba(255,255,255,0.1);
            padding: 12px;
            border-radius: 6px;
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 12px;
            align-items: center;
        }

        .custom-product-inputs {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 10px;
        }

        .custom-product-inputs input {
            padding: 8px 12px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 4px;
            background: rgba(255,255,255,0.9);
            color: #333;
            font-size: 0.9em;
        }

        .custom-product-inputs input::placeholder {
            color: #666;
        }

        .custom-product-price {
            color: white;
            font-weight: bold;
            font-size: 0.95em;
        }

        .remove-custom-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .remove-custom-btn:hover {
            background: rgba(255,255,255,0.4);
        }

        /* PDF Template Styles */
        .pdf-template {
            width: 210mm;
            min-height: 297mm;
            background: white;
            padding: 20mm;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 12px;
            line-height: 1.4;
            color: #333;
            position: absolute;
            left: -9999px;
            top: 0;
        }

        .pdf-header {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #2B3E50;
            padding-bottom: 20px;
        }

        .pdf-logo {
            width: 80px;
            height: auto;
            margin-right: 30px;
        }

        .pdf-company-info {
            flex: 1;
            text-align: center;
        }

        .pdf-title {
            font-size: 28px;
            font-weight: bold;
            color: #2B3E50;
            margin-bottom: 8px;
        }

        .pdf-subtitle {
            font-size: 16px;
            color: #666;
            margin-bottom: 5px;
        }

        .pdf-hotline {
            font-size: 14px;
            font-weight: bold;
            color: #D35400;
        }

        .pdf-date {
            text-align: right;
            font-size: 12px;
            margin-bottom: 20px;
        }

        .pdf-customer-info {
            background: #F7F9FB;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 25px;
            border-left: 4px solid #2B3E50;
        }

        .pdf-customer-title {
            font-size: 16px;
            font-weight: bold;
            color: #2B3E50;
            margin-bottom: 10px;
        }

        .pdf-customer-row {
            display: flex;
            margin-bottom: 5px;
        }

        .pdf-customer-label {
            font-weight: bold;
            width: 150px;
        }

        .pdf-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 25px;
        }

        .pdf-table th {
            background: #2B3E50;
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: bold;
            font-size: 11px;
        }

        .pdf-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #eee;
            font-size: 11px;
        }

        .pdf-table tr:nth-child(even) {
            background: #F7F9FB;
        }

        .pdf-total-section {
            background: #2B3E50;
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: right;
            margin-bottom: 20px;
        }

        .pdf-total-text {
            font-size: 18px;
            font-weight: bold;
        }

        .pdf-footer {
            text-align: center;
            color: #2B3E50;
            font-style: italic;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }

        /* Success and Warning States */
        .success-message {
            background: #27AE60;
            color: white;
            padding: 12px 16px;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: bold;
        }

        .warning-message {
            background: #F39C12;
            color: white;
            padding: 12px 16px;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: bold;
        }

        .error-message {
            background: #E74C3C;
            color: white;
            padding: 12px 16px;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: bold;
        }

        .info-message {
            background: #3498DB;
            color: white;
            padding: 12px 16px;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .logo {
                height: 50px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .controls {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .custom-product-row {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .custom-product-inputs {
                grid-template-columns: 1fr;
            }
            
            table {
                font-size: 12px;
            }
            
            th, td {
                padding: 8px 5px;
            }
            
            .quote-item {
                grid-template-columns: 1fr;
                gap: 10px;
                text-align: center;
            }
            
            .selected-items-grid {
                grid-template-columns: 1fr;
            }
            
            .image-cell {
                width: 100px;
            }
            
            .product-image-small {
                width: 70px;
                height: 70px;
            }
            
            .no-image-small {
                width: 70px;
                height: 70px;
                font-size: 8px;
            }
            
            .module-name-cell {
                max-width: 80px;
            }
            
            .structure-cell, .function-cell {
                max-width: 100px;
            }
            
            .note-cell {
                max-width: 80px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <img src="Logo.png" alt="SANKO Logo" class="logo" />
                <div class="header-text">
                    <h1>SANKO</h1>
                    <div class="subtitle">Tủ bếp Inox hệ Module</div>
                </div>
            </div>
        </header>

        <div class="controls">
            <input type="text" id="searchBox" class="search-box" placeholder="🔍 Tìm kiếm module..." />

            <select id="filterSelect" class="filter-select">
                <option value="">Tất cả loại module</option>
            </select>

            <div style="display: flex; gap: 10px;">
                <button id="refreshDataBtn" class="btn btn-secondary" onclick="refreshData()" title="Tải lại dữ liệu từ Google Drive">
                    🔄 Refresh
                </button>
                <button id="createQuoteBtn" class="quote-btn" disabled>
                    📄 Tạo báo giá (<span id="selectedCount">0</span>)
                </button>
            </div>
        </div>

        <!-- Selected Products Box -->
        <div id="selectedProductsBox" class="selected-products-box">
            <div class="selected-box-header">
                <div class="selected-box-title">
                    📋 Sản phẩm đã chọn (<span id="selectedCountInBox">0</span>)
                </div>
                <button class="clear-all-btn" onclick="clearAllSelected()">🗑️ Xóa tất cả</button>
            </div>
            <div id="selectedItemsGrid" class="selected-items-grid">
                <!-- Selected items will appear here -->
            </div>
        </div>

        <!-- Custom Products Section -->
        <div id="customProductsBox" class="custom-products-box">
            <div class="custom-box-header">
                <div class="custom-box-title">
                    ✏️ Sản phẩm tự định nghĩa
                </div>
                <button class="add-custom-btn" onclick="addCustomProduct()">➕ Thêm sản phẩm</button>
            </div>
            <div id="customProductsContainer" class="custom-products-container">
                <!-- Custom products will appear here -->
            </div>
        </div>

        <div id="loadingMessage" class="loading" style="display: none;">
            Đang tải dữ liệu...
        </div>

        <div class="products-table">
            <div class="table-container">
                <table id="productsTable">
                    <thead>
                        <tr>
                            <th>
                                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" title="Chọn tất cả" />
                            </th>
                            <th>SỐ LƯỢNG</th>
                            <th>HÌNH ẢNH</th>
                            <th>LOẠI MODULE</th>
                            <th>TÊN MODULE</th>
                            <th>DÀI</th>
                            <th>RỘNG</th>
                            <th>CAO</th>
                            <th>CẤU TẠO/ KẾT CẤU</th>
                            <th>CÔNG NĂNG KHUYẾN CÁO</th>
                            <th>LƯU Ý</th>
                            <th>GIÁ BÁN</th>
                        </tr>
                    </thead>
                    <tbody id="productsTableBody">
                        <!-- Products will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Quote Modal -->
    <div id="quoteModal" class="quote-modal">
        <div class="quote-content">
            <button class="close-modal" onclick="closeQuoteModal()">&times;</button>
            <div class="quote-header">
                <h2>BẢNG BÁO GIÁ</h2>
                <div id="quoteDate"></div>
            </div>
            
            <!-- Customer Information -->
            <div class="customer-info">
                <h3>Thông tin khách hàng:</h3>
                <div class="customer-fields">
                    <div class="field-group">
                        <label for="customerName">Tên khách hàng:</label>
                        <input type="text" id="customerName" placeholder="Nhập tên khách hàng">
                    </div>
                    <div class="field-group">
                        <label for="customerPhone">Số điện thoại:</label>
                        <input type="text" id="customerPhone" placeholder="Nhập số điện thoại">
                    </div>
                </div>
            </div>
            
            <div id="quoteItems" class="quote-items">
                <!-- Quote items will be generated here -->
            </div>
            <div class="quote-total">
                <div>Tổng tiền: <span id="quoteTotalAmount" class="total-amount">0 VND</span></div>
            </div>
            <div class="quote-actions">
                <button class="btn btn-primary" onclick="exportToPDF()">📄 Xuất PDF</button>
                <button class="btn btn-primary" onclick="exportToExcel()" style="background: #28a745;">📊 Xuất Excel</button>
                <button class="btn btn-secondary" onclick="closeQuoteModal()">Đóng</button>
            </div>
        </div>
    </div>

    <!-- Include jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Include html2canvas for better font support -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Include SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        // Configuration for Google Sheets API (No CORS issues!)
        const GOOGLE_SHEETS_CONFIG = {
            // Google Sheets ID (từ URL của Google Sheets)
            SHEET_ID: '1Z7TGYfXhcY28Obc2oLpp39MgfaOJQGAPq1_jdy2vE5U', // Google Sheets native format - đã convert
            API_KEY: 'AIzaSyC5cCJ47c7mSJSO2cRxplHGt4zrDZwFbN0', // Google API Key
            RANGE: 'TTSP!A2:J', // Sheet name là "TTSP", lấy từ hàng 2 (bỏ header), cột A đến J
            IMAGES_FOLDER_ID: '1Bta6BA18DvI1VynXX7SluCb7ZNkSr70k', // ID của folder chứa hình ảnh
            IMAGES_BASE_URL: 'https://lh3.googleusercontent.com/d/',
            // Cache for image IDs (will be populated automatically)
            IMAGE_IDS_CACHE: {},
            CACHE_EXPIRY: 3600000 // 1 hour in milliseconds
        };

        let allProductsData = [];
        let filteredProductsData = [];
        let selectedProducts = new Map(); // Changed to Map to store {id: quantity}
        let customProducts = [];
        let customProductIdCounter = 1;

        // Function to convert Google Sheets data to products array
        function convertSheetsToProducts(sheetsData) {
            const products = [];
            
            // Bỏ qua hàng đầu (header) nếu có
            const dataRows = sheetsData.values || [];
            
            dataRows.forEach((row, index) => {
                // Kiểm tra xem hàng có dữ liệu không
                if (row.length >= 3 && row[2]) { // Cần ít nhất có TÊN MODULE
                    const product = {
                        id: parseInt(row[0]) || (index + 1), // STT hoặc auto increment
                        type: row[1] || 'CLASSIC', // LOẠI MODULE
                        name: row[2] || '', // TÊN MODULE
                        length: parseInt(row[3]) || 0, // DÀI
                        width: parseInt(row[4]) || 0, // RỘNG  
                        height: parseInt(row[5]) || 0, // CAO
                        structure: row[6] || '', // CẤU TẠO/ KẾT CẤU
                        function: row[7] || '', // CÔNG NĂNG KHUYẾN CÁO
                        note: row[8] || '', // LƯU Ý
                        price: parseInt(row[9]) || 0 // GIÁ BÁN
                    };
                    products.push(product);
                }
            });
            
            return products;
        }

        // Function to load products data from Google Sheets (No CORS!)
        async function loadProductsData() {
            document.getElementById('loadingMessage').style.display = 'block';
            document.getElementById('loadingMessage').textContent = 'Đang tải dữ liệu từ Google Sheets...';
            
            const sheetsUrl = `https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_SHEETS_CONFIG.SHEET_ID}/values/${GOOGLE_SHEETS_CONFIG.RANGE}?key=${GOOGLE_SHEETS_CONFIG.API_KEY}`;
            const response = await fetch(sheetsUrl);
            const sheetsData = await response.json();
            const productsData = convertSheetsToProducts(sheetsData);
            
            allProductsData = productsData;
            filteredProductsData = [...allProductsData];
            populateFilters();
            displayProducts(filteredProductsData);
            updateUI();
            renderCustomProducts();
            document.getElementById('loadingMessage').style.display = 'none';
        }

        // Function to load image IDs from Google Drive API (giữ nguyên cho images)
        async function loadImageIdsWithAPI(useCache = true) {
            // Check cache first
            if (useCache) {
                const cached = localStorage.getItem('sanko_image_cache');
                if (cached) {
                    const cacheData = JSON.parse(cached);
                    if (Date.now() - cacheData.timestamp < GOOGLE_SHEETS_CONFIG.CACHE_EXPIRY) {
                        GOOGLE_SHEETS_CONFIG.IMAGE_IDS_CACHE = cacheData.imageIds;
                        return;
                    }
                }
            }
            
            const apiUrl = `https://www.googleapis.com/drive/v3/files?q='${GOOGLE_SHEETS_CONFIG.IMAGES_FOLDER_ID}'+in+parents&key=${GOOGLE_SHEETS_CONFIG.API_KEY}&fields=files(id,name)`;
            const response = await fetch(apiUrl);
            
            if (response.ok) {
                const result = await response.json();
                if (result.files) {
                    result.files.forEach(file => {
                        const nameWithoutExt = file.name.replace(/\.[^/.]+$/, '');
                        GOOGLE_SHEETS_CONFIG.IMAGE_IDS_CACHE[nameWithoutExt] = file.id;
                    });
                    
                    if (useCache) {
                        localStorage.setItem('sanko_image_cache', JSON.stringify({
                            imageIds: GOOGLE_SHEETS_CONFIG.IMAGE_IDS_CACHE,
                            timestamp: Date.now()
                        }));
                    }
                }
            }
        }





        // Helper function to find file ID from product name
        function findFileId(productName) {
            // Check cache with exact product name first
            if (GOOGLE_SHEETS_CONFIG.IMAGE_IDS_CACHE[productName]) {
                return GOOGLE_SHEETS_CONFIG.IMAGE_IDS_CACHE[productName];
            }
            
            // Try with common file extensions
            const extensions = ['jpg', 'jpeg', 'png', 'webp'];
            for (const ext of extensions) {
                const keyWithExt = `${productName}.${ext}`;
                if (GOOGLE_SHEETS_CONFIG.IMAGE_IDS_CACHE[keyWithExt]) {
                    return GOOGLE_SHEETS_CONFIG.IMAGE_IDS_CACHE[keyWithExt];
                }
            }
            
            return '';
        }

        // Function to get image URL or file ID from Google Drive
        function getImageUrl(productName, returnType = 'url') {
            const fileId = findFileId(productName);
            
            // Return file ID only if requested
            if (returnType === 'id') {
                return fileId;
            }
            
            // Return full URL if file ID found
            if (fileId) {
                const url = `${GOOGLE_SHEETS_CONFIG.IMAGES_BASE_URL}${fileId}`;
                return url;
            }
            
            // Return placeholder when image not found on Google Drive
            return 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iI2Y1ZjVmNSIvPjx0ZXh0IHg9IjUwIiB5PSI1MCIgZm9udC1zaXplPSIxMiIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5vIEltYWdlPC90ZXh0Pjwvc3ZnPg==';
        }
        
        // Helper function to get file ID only (for backward compatibility)
        function getFileId(productName) {
            return getImageUrl(productName, 'id');
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            // Load image IDs first
            await loadImageIdsWithAPI();
            // Then load products data
            await loadProductsData();
        });

        // Function to refresh data from Google Drive
        async function refreshData() {
            const refreshBtn = document.getElementById('refreshDataBtn');
            refreshBtn.disabled = true;
            refreshBtn.textContent = '🔄 Đang tải...';
            
            localStorage.removeItem('sanko_image_cache');
            GOOGLE_SHEETS_CONFIG.IMAGE_IDS_CACHE = {};
            await loadImageIdsWithAPI(false);
            await loadProductsData();
            refreshBtn.textContent = '✅ Đã cập nhật';
            
            setTimeout(() => {
                refreshBtn.textContent = '🔄 Refresh';
                refreshBtn.disabled = false;
            }, 2000);
        }



        // Extract Excel generation logic
        async function generateExcelFile(exportData) {
            const { items, total, customerName, customerPhone } = exportData;
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            
            // Create worksheet data
            const wsData = createExcelWorksheetData(items, total, customerName, customerPhone);
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            
            // Apply formatting and colors
            applyExcelFormatting(ws, items.length, customerName || customerPhone);
            
            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Báo giá SANKO');
            
            // Generate filename and export
            const fileName = customerName ? 
                `bao-gia-sanko-${customerName.replace(/\s+/g, '-').toLowerCase()}.xlsx` : 
                'bao-gia-sanko.xlsx';
            
            XLSX.writeFile(wb, fileName);
        }

        // Extract Excel worksheet data creation
        function createExcelWorksheetData(items, total, customerName, customerPhone) {
            const wsData = [];
            
            // Header section
            wsData.push(['BẢNG BÁO GIÁ SANKO']);
            wsData.push(['Tủ bếp Inox hệ Module']);
            wsData.push(['Hotline: 0844 803 777']);
            wsData.push(['']);
            wsData.push([`Ngày lập: ${new Date().toLocaleDateString('vi-VN')}`]);
            wsData.push(['']);
            
            // Customer info
            if (customerName || customerPhone) {
                wsData.push(['THÔNG TIN KHÁCH HÀNG']);
                if (customerName) wsData.push([`Tên khách hàng: ${customerName}`]);
                if (customerPhone) wsData.push([`Số điện thoại: ${customerPhone}`]);
                wsData.push(['']);
            }
            
            // Table headers
            const headerRow = ['STT', 'TÊN MODULE', 'LOẠI', 'KÍCH THƯỚC', 'CẤU TẠO', 'CÔNG NĂNG', 'GIÁ ĐƠNVỊ', 'SỐ LƯỢNG', 'THÀNH TIỀN'];
            wsData.push(headerRow);
            
            // Add products
            items.forEach((item, index) => {
                const itemSubtotal = item.subtotal || (item.price * item.quantity);
                const dimensions = !item.isCustom ? 
                    `${item.length || 'N/A'}×${item.width || 'N/A'}×${item.height || 'N/A'}mm` : 
                    'Tùy chỉnh';
                
                wsData.push([
                    index + 1,
                    item.name,
                    item.type || 'Tùy chỉnh',
                    dimensions,
                    item.structure || 'N/A',
                    item.function || 'N/A',
                    item.price,
                    item.quantity,
                    itemSubtotal
                ]);
            });
            
            // Add total row
            wsData.push(['']);
            wsData.push(['', '', '', '', '', '', '', 'TỔNG TIỀN:', total]);
            
            return wsData;
        }

        // Function to apply Excel formatting and colors
        function applyExcelFormatting(ws, itemCount, hasCustomerInfo) {
            // Set column widths
            const colWidths = [
                { wch: 5 },  // STT
                { wch: 25 }, // TÊN MODULE
                { wch: 12 }, // LOẠI
                { wch: 18 }, // KÍCH THƯỚC
                { wch: 30 }, // CẤU TẠO
                { wch: 35 }, // CÔNG NĂNG
                { wch: 15 }, // GIÁ ĐƠN VỊ
                { wch: 10 }, // SỐ LƯỢNG
                { wch: 18 }  // THÀNH TIỀN
            ];
            ws['!cols'] = colWidths;
            
            // Calculate row positions
            let headerRowIndex = hasCustomerInfo ? 9 : 6; // Row index where table headers start
            let dataStartRow = headerRowIndex + 1;
            let totalRowIndex = dataStartRow + itemCount + 1;
            
            // Helper function to get cell address
            const getCellAddr = (row, col) => XLSX.utils.encode_cell({ r: row, c: col });
            
            // Format title (row 1)
            const titleCell = getCellAddr(0, 0);
            if (!ws[titleCell]) ws[titleCell] = { v: '' };
            ws[titleCell].s = {
                font: { bold: true, sz: 16, color: { rgb: "FFFFFF" } },
                fill: { fgColor: { rgb: "667EEA" } },
                alignment: { horizontal: "center", vertical: "center" }
            };
            
            // Merge title across columns
            if (!ws['!merges']) ws['!merges'] = [];
            ws['!merges'].push({ s: { r: 0, c: 0 }, e: { r: 0, c: 8 } });
            
            // Format subtitle (row 2)
            const subtitleCell = getCellAddr(1, 0);
            if (!ws[subtitleCell]) ws[subtitleCell] = { v: '' };
            ws[subtitleCell].s = {
                font: { sz: 12, color: { rgb: "666666" } },
                alignment: { horizontal: "center" }
            };
            ws['!merges'].push({ s: { r: 1, c: 0 }, e: { r: 1, c: 8 } });
            
            // Format hotline (row 3)
            const hotlineCell = getCellAddr(2, 0);
            if (!ws[hotlineCell]) ws[hotlineCell] = { v: '' };
            ws[hotlineCell].s = {
                font: { bold: true, color: { rgb: "FF6B6B" } },
                alignment: { horizontal: "center" }
            };
            ws['!merges'].push({ s: { r: 2, c: 0 }, e: { r: 2, c: 8 } });
            
            // Format customer info section
            if (hasCustomerInfo) {
                const customerHeaderCell = getCellAddr(6, 0);
                if (!ws[customerHeaderCell]) ws[customerHeaderCell] = { v: '' };
                ws[customerHeaderCell].s = {
                    font: { bold: true, sz: 12, color: { rgb: "667EEA" } },
                    fill: { fgColor: { rgb: "F8F9FA" } },
                    border: {
                        left: { style: "thick", color: { rgb: "667EEA" } }
                    }
                };
            }
            
            // Format table headers
            for (let col = 0; col < 9; col++) {
                const headerCell = getCellAddr(headerRowIndex, col);
                if (!ws[headerCell]) ws[headerCell] = { v: '' };
                ws[headerCell].s = {
                    font: { bold: true, color: { rgb: "FFFFFF" } },
                    fill: { fgColor: { rgb: "667EEA" } },
                    alignment: { horizontal: "center", vertical: "center" },
                    border: {
                        top: { style: "thin", color: { rgb: "FFFFFF" } },
                        bottom: { style: "thin", color: { rgb: "FFFFFF" } },
                        left: { style: "thin", color: { rgb: "FFFFFF" } },
                        right: { style: "thin", color: { rgb: "FFFFFF" } }
                    }
                };
            }
            
            // Format data rows with alternating colors
            for (let row = dataStartRow; row < dataStartRow + itemCount; row++) {
                const isEvenRow = (row - dataStartRow) % 2 === 0;
                const fillColor = isEvenRow ? "F8F9FA" : "FFFFFF";
                
                for (let col = 0; col < 9; col++) {
                    const cellAddr = getCellAddr(row, col);
                    if (!ws[cellAddr]) ws[cellAddr] = { v: '' };
                    
                    let cellStyle = {
                        fill: { fgColor: { rgb: fillColor } },
                        border: {
                            top: { style: "thin", color: { rgb: "E0E0E0" } },
                            bottom: { style: "thin", color: { rgb: "E0E0E0" } },
                            left: { style: "thin", color: { rgb: "E0E0E0" } },
                            right: { style: "thin", color: { rgb: "E0E0E0" } }
                        }
                    };
                    
                    // Special formatting for specific columns
                    if (col === 0) { // STT column
                        cellStyle.alignment = { horizontal: "center" };
                    } else if (col === 6 || col === 8) { // Price columns
                        cellStyle.numFmt = '#,##0';
                        cellStyle.alignment = { horizontal: "right" };
                        cellStyle.font = { color: { rgb: "FF6B6B" } };
                    } else if (col === 7) { // Quantity column
                        cellStyle.alignment = { horizontal: "center" };
                    }
                    
                    ws[cellAddr].s = cellStyle;
                }
            }
            
            // Format total row
            const totalLabelCell = getCellAddr(totalRowIndex, 7);
            const totalValueCell = getCellAddr(totalRowIndex, 8);
            
            if (!ws[totalLabelCell]) ws[totalLabelCell] = { v: '' };
            ws[totalLabelCell].s = {
                font: { bold: true, sz: 12, color: { rgb: "FFFFFF" } },
                fill: { fgColor: { rgb: "667EEA" } },
                alignment: { horizontal: "center" }
            };
            
            if (!ws[totalValueCell]) ws[totalValueCell] = { v: '' };
            ws[totalValueCell].s = {
                font: { bold: true, sz: 12, color: { rgb: "FFFFFF" } },
                fill: { fgColor: { rgb: "667EEA" } },
                alignment: { horizontal: "right" },
                numFmt: '#,##0'
            };
            
            // Set row heights
            if (!ws['!rows']) ws['!rows'] = [];
            ws['!rows'][0] = { hpt: 25 }; // Title row height
            ws['!rows'][headerRowIndex] = { hpt: 20 }; // Header row height
            ws['!rows'][totalRowIndex] = { hpt: 20 }; // Total row height
        }

        // Event listeners
        document.getElementById('searchBox').addEventListener('input', filterProducts);
        document.getElementById('filterSelect').addEventListener('change', filterProducts);
        document.getElementById('createQuoteBtn').addEventListener('click', createQuote);

        function populateFilters() {
            const filterSelect = document.getElementById('filterSelect');
            const types = [...new Set(allProductsData.map(p => p.type))].filter(Boolean);
            
            // Clear existing options except "All"
            filterSelect.innerHTML = '<option value="">Tất cả loại module</option>';
            
            types.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                filterSelect.appendChild(option);
            });
        }

        function displayProducts(products = null) {
            const tbody = document.getElementById('productsTableBody');
            
            // Apply filtering if no products provided
            if (!products) {
                const searchTerm = document.getElementById('searchBox').value.toLowerCase();
                const filterType = document.getElementById('filterSelect').value;
                
                filteredProductsData = allProductsData.filter(product => {
                    const matchesSearch = !searchTerm || 
                        product.name.toLowerCase().includes(searchTerm) ||
                        product.type.toLowerCase().includes(searchTerm) ||
                        product.structure.toLowerCase().includes(searchTerm) ||
                        product.function.toLowerCase().includes(searchTerm);
                        
                    const matchesFilter = !filterType || product.type === filterType;
                    return matchesSearch && matchesFilter;
                });
                
                products = filteredProductsData;
            }
            
            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" style="text-align: center; padding: 50px;">Không tìm thấy sản phẩm nào.</td></tr>';
                updateUI();
                return;
            }

            tbody.innerHTML = products.map(product => `
                <tr class="${selectedProducts.has(product.id) ? 'selected' : ''}" id="row-${product.id}">
                    <td class="checkbox-cell">
                        <input type="checkbox" 
                               ${selectedProducts.has(product.id) ? 'checked' : ''}
                               data-product-id="${product.id}"
                               onchange="toggleProduct(this.dataset.productId)" />
                    </td>
                    <td class="quantity-cell">
                        <input type="number" 
                               class="quantity-input"
                               min="1" 
                               max="999"
                               value="${selectedProducts.get(product.id) || 1}"
                               ${!selectedProducts.has(product.id) ? 'disabled' : ''}
                               onchange="updateQuantity(${product.id}, this.value)" />
                    </td>
                    <td class="image-cell">
                        <img src="${getImageUrl(product.name)}" 
                             alt="${product.name}"
                             class="product-image-small" />
                    </td>
                    <td><span class="type-badge">${product.type}</span></td>
                    <td class="module-name-cell">${product.name}</td>
                    <td class="dimension-cell">${product.length || '-'}</td>
                    <td class="dimension-cell">${product.width || '-'}</td>
                    <td class="dimension-cell">${product.height || '-'}</td>
                    <td class="structure-cell">${product.structure || '-'}</td>
                    <td class="function-cell">${product.function || '-'}</td>
                    <td class="note-cell">${product.note || '-'}</td>
                    <td class="price-cell">${formatPrice(product.price)}</td>
                </tr>
            `).join('');
            
            updateUI();
        }

        // Helper function for common row UI updates
        function updateRowUI(productId, isSelected, quantity = 1) {
            const row = document.getElementById(`row-${productId}`);
            if (!row) return;
            
            const checkbox = row.querySelector('input[type="checkbox"]');
            const quantityInput = row.querySelector('.quantity-input');
            
            row.classList.toggle('selected', isSelected);
            if (checkbox) checkbox.checked = isSelected;
            if (quantityInput) {
                quantityInput.disabled = !isSelected;
                quantityInput.value = quantity;
            }
        }

        // Unified UI update function
        function updateUI() {
            // Update counts and button state
            const count = selectedProducts.size;
            const validCustomProducts = customProducts.filter(p => p.name.trim() && p.price > 0);
            const validCustomProductsCount = validCustomProducts.length;
            const totalQuantity = Array.from(selectedProducts.values()).reduce((sum, qty) => sum + qty, 0);
            const totalItems = count + validCustomProductsCount;
            
            document.getElementById('selectedCount').textContent = totalQuantity + validCustomProductsCount;
            document.getElementById('selectedCountInBox').textContent = count;
            document.getElementById('createQuoteBtn').disabled = totalItems === 0;
            
            // Update select all checkbox
            const selectAllCheckbox = document.getElementById('selectAll');
            const visibleProductIds = filteredProductsData.map(p => p.id);
            const selectedVisibleProducts = visibleProductIds.filter(id => selectedProducts.has(id));
            
            if (selectedVisibleProducts.length === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            } else if (selectedVisibleProducts.length === visibleProductIds.length) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            }
            
            // Update selected products display
            const selectedItemsGrid = document.getElementById('selectedItemsGrid');
            const selectedItems = allProductsData.filter(p => selectedProducts.has(p.id));
            
            if (selectedItems.length === 0) {
                selectedItemsGrid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; opacity: 0.7; font-style: italic;">Chưa có sản phẩm nào được chọn</div>';
            } else {
                selectedItemsGrid.innerHTML = selectedItems.map(item => {
                    const quantity = selectedProducts.get(item.id) || 1;
                    return `
                    <div class="selected-item" id="selected-item-${item.id}">
                        <div class="selected-item-info">
                            <div class="selected-item-name">${item.name} (x${quantity})</div>
                            <div class="selected-item-details">
                                ${item.type} - ${formatPrice(item.price * quantity)} VND
                            </div>
                        </div>
                        <button class="remove-item-btn" onclick="removeSelectedItem(${item.id})" title="Xóa sản phẩm">
                            ×
                        </button>
                    </div>`;
                }).join('');
            }
        }

        // Simplified filter function - just calls displayProducts
        function filterProducts() {
            displayProducts();
        }

        function toggleProduct(productId) {
            productId = parseInt(productId);
            
            if (selectedProducts.has(productId)) {
                selectedProducts.delete(productId);
                updateRowUI(productId, false, 1);
            } else {
                selectedProducts.set(productId, 1);
                updateRowUI(productId, true, 1);
            }
            
            updateUI();
        }

        function updateQuantity(productId, quantity) {
            quantity = parseInt(quantity) || 1;
            if (quantity < 1) quantity = 1;
            if (quantity > 999) quantity = 999;
            
            if (selectedProducts.has(productId)) {
                selectedProducts.set(productId, quantity);
                updateUI();
            }
        }

        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAll');
            const visibleProductIds = filteredProductsData.map(p => p.id);
            
            if (selectAllCheckbox.checked) {
                // Select all visible products
                visibleProductIds.forEach(id => selectedProducts.set(id, 1));
            } else {
                // Deselect all visible products
                visibleProductIds.forEach(id => selectedProducts.delete(id));
            }
            
            // Re-render to reflect changes
            displayProducts(filteredProductsData);
            updateUI();
        }

        function removeSelectedItem(productId) {
            selectedProducts.delete(productId);
            updateRowUI(productId, false, 1);
            updateUI();
        }

        function clearAllSelected() {
            selectedProducts.clear();
            // Re-render to reflect changes
            displayProducts(filteredProductsData);
            updateUI();
        }

        // Unified export preparation function
        function prepareExportData() {
            const allSelectedItems = getAllSelectedItems();
            if (allSelectedItems.length === 0) return null;
            
            return {
                items: allSelectedItems,
                total: calculateTotal(allSelectedItems),
                customerName: document.getElementById('customerName').value || '',
                customerPhone: document.getElementById('customerPhone').value || ''
            };
        }

        // Simplified quote creation
        function createQuote() {
            const exportData = prepareExportData();
            if (!exportData) return;

            // Set quote date
            document.getElementById('quoteDate').textContent = 
                'Ngày: ' + new Date().toLocaleDateString('vi-VN');

            // Generate quote items
            const quoteItemsHtml = generateQuoteItemsHTML(exportData.items);
            document.getElementById('quoteItems').innerHTML = quoteItemsHtml;
            document.getElementById('quoteTotalAmount').textContent = formatPrice(exportData.total) + ' VND';
            document.getElementById('quoteModal').style.display = 'block';
        }

        // Extract quote items HTML generation
        function generateQuoteItemsHTML(items) {
            return items.map((item, index) => `
                <div class="quote-item">
                    <div style="font-weight: bold;">${index + 1}</div>
                    <div>
                        <div style="font-weight: bold; margin-bottom: 5px;">${item.name}</div>
                        <div style="font-size: 0.9em; color: #666;">
                            ${item.isCustom ? 'Sản phẩm tự định nghĩa' : 
                                item.type + ' - ' + (item.length ? item.length + 'x' + item.width + 'x' + item.height + 'mm' : 'N/A')
                            }
                        </div>
                    </div>
                    <div style="text-align: center;">${item.quantity}</div>
                    <div style="text-align: right; font-weight: bold; color: #95A5A6;">
                        ${formatPrice(item.subtotal || (item.price * item.quantity))} VND
                    </div>
                </div>
            `).join('');
        }

        function closeQuoteModal() {
            document.getElementById('quoteModal').style.display = 'none';
        }

        async function exportToPDF() {
            const exportData = prepareExportData();
            if (!exportData) return;
            await generateCanvasPDF(exportData);
        }

        async function exportToExcel() {
            const exportData = prepareExportData();
            if (!exportData) return;
            await generateExcelFile(exportData);
        }        // PDF generation using HTML2Canvas for high visual quality
        // =============== PDF EXPORT FUNCTIONS ===============
        // Calculate items per page based on content
        function calculateItemsPerPage() {
            // Based on A4 page height and typical item height
            // Header: ~120px, Customer info: ~80px, Total section: ~60px, Footer: ~40px
            // Available space for items: ~600px
            // Each item row: ~25px 
            return 20; // Conservative estimate to ensure no overflow
        }

        // Generate PDF template HTML with pagination support
        function generatePDFTemplateHTML(items, total, customerName, customerPhone, pageNumber = 1, totalPages = 1, isFirstPage = true, isLastPage = true) {
            const customerInfoHTML = (customerName || customerPhone) && isFirstPage ? `
                <div style="background: #F7F9FB; padding: 15px; border-radius: 8px; margin-bottom: 25px; border-left: 4px solid #2B3E50;">
                    <div style="font-size: 16px; font-weight: bold; color: #2B3E50; margin-bottom: 10px;">THÔNG TIN KHÁCH HÀNG</div>
                    ${customerName ? `<div style="margin-bottom: 5px; color: #333;"><strong>Tên khách hàng:</strong> ${customerName}</div>` : ''}
                    ${customerPhone ? `<div style="margin-bottom: 5px; color: #333;"><strong>Số điện thoại:</strong> ${customerPhone}</div>` : ''}
                </div>` : '';

            const itemsHTML = items.map((item, index) => {
                const itemSubtotal = item.subtotal || (item.price * item.quantity);
                const globalIndex = item.globalIndex || index; // Use global index if available
                return `
                    <tr style="${index % 2 === 0 ? 'background: #F7F9FB;' : 'background: white;'}">
                        <td style="padding: 10px 8px; border: 1px solid #ddd; font-size: 11px; text-align: center; color: #333;">${globalIndex + 1}</td>
                        <td style="padding: 10px 8px; border: 1px solid #ddd; font-size: 11px; color: #333;"><strong>${item.name}</strong></td>
                        <td style="padding: 10px 8px; border: 1px solid #ddd; font-size: 11px; color: #333; text-align: center;">${!item.isCustom ? `${item.length || 'N/A'}×${item.width || 'N/A'}×${item.height || 'N/A'}mm` : 'Tùy chỉnh'}</td>
                        <td style="padding: 10px 8px; border: 1px solid #ddd; font-size: 11px; text-align: right; color: #333;">${formatPrice(item.price)}</td>
                        <td style="padding: 10px 8px; border: 1px solid #ddd; font-size: 11px; text-align: center; color: #333;">${item.quantity}</td>
                        <td style="padding: 10px 8px; border: 1px solid #ddd; font-size: 11px; text-align: right; color: #333;"><strong>${formatPrice(itemSubtotal)}</strong></td>
                    </tr>`;
            }).join('');

            const totalSectionHTML = isLastPage ? `
                <div style="background: #2B3E50; color: white; padding: 15px; border-radius: 8px; text-align: right; margin-bottom: 20px;">
                    <div style="font-size: 18px; font-weight: bold;">TỔNG TIỀN: ${formatPrice(total)} VND</div>
                </div>` : '';

            const footerHTML = isLastPage ? `
                <div style="text-align: center; color: #2B3E50; font-style: italic; border-top: 1px solid #eee; padding-top: 15px;">
                    <div>Cảm ơn quý khách đã tin tưởng sản phẩm SANKO!</div>
                    <div>Mọi thắc mắc xin liên hệ: 0844 803 777</div>
                </div>` : '';

            const pageInfoHTML = totalPages > 1 ? `
                <div style="text-align: center; font-size: 10px; color: #666; margin-bottom: 10px;">
                    Trang ${pageNumber} / ${totalPages}
                </div>` : '';

            return `
                <div style="display: flex; align-items: center; margin-bottom: 30px; border-bottom: 3px solid #2B3E50; padding-bottom: 20px;">
                    <img src="Logo.png" alt="SANKO Logo" style="width: 200px; height: auto; margin-right: 30px;" />
                    <div style="flex: 1; text-align: center;">
                        <div style="font-size: 28px; font-weight: bold; color: #2B3E50; margin-bottom: 8px;">BẢNG BÁO GIÁ</div>
                        <div style="font-size: 16px; color: #666; margin-bottom: 5px;">SANKO - Tủ bếp Inox hệ Module</div>
                        <div style="font-size: 14px; font-weight: bold; color: #D35400;">Hotline: 0844 803 777</div>
                    </div>
                </div>
                <div style="text-align: right; font-size: 12px; margin-bottom: 20px; color: #333;">
                    Ngày lập: ${new Date().toLocaleDateString('vi-VN')}
                </div>
                ${pageInfoHTML}
                ${customerInfoHTML}
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 25px; border: 1px solid #ddd;">
                    <thead>
                        <tr style="background: #2B3E50; color: white;">
                            <th style="padding: 12px 8px; text-align: center; font-weight: bold; font-size: 12px; border: 1px solid #ddd;">STT</th>
                            <th style="padding: 12px 8px; text-align: left; font-weight: bold; font-size: 12px; border: 1px solid #ddd;">TÊN MODULE</th>
                            <th style="padding: 12px 8px; text-align: center; font-weight: bold; font-size: 12px; border: 1px solid #ddd;">THÔNG SỐ</th>
                            <th style="padding: 12px 8px; text-align: right; font-weight: bold; font-size: 12px; border: 1px solid #ddd;">GIÁ</th>
                            <th style="padding: 12px 8px; text-align: center; font-weight: bold; font-size: 12px; border: 1px solid #ddd;">SL</th>
                            <th style="padding: 12px 8px; text-align: right; font-weight: bold; font-size: 12px; border: 1px solid #ddd;">THÀNH TIỀN</th>
                        </tr>
                    </thead>
                    <tbody>${itemsHTML}</tbody>
                </table>
                ${totalSectionHTML}
                ${footerHTML}`;
        }

        // Helper to create PDF template element
        function createPDFElement() {
            const element = document.createElement('div');
            Object.assign(element.style, {
                position: 'fixed',
                left: '-9999px',
                top: '-9999px',
                width: '794px',
                minHeight: '1123px',
                backgroundColor: '#ffffff',
                padding: '40px',
                fontFamily: 'Inter, "Segoe UI", Tahoma, Geneva, Verdana, sans-serif',
                fontSize: '14px',
                lineHeight: '1.4',
                color: '#333',
                zIndex: '-1000',
                visibility: 'hidden',
                opacity: '0',
                boxSizing: 'border-box'
            });
            return element;
        }

        async function generateCanvasPDF(exportData) {
            const { items, total, customerName, customerPhone } = exportData;
            
            const itemsPerPage = calculateItemsPerPage();
            const totalPages = Math.ceil(items.length / itemsPerPage);
            
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
            pdf.deletePage(1);
            
            for (let pageIndex = 0; pageIndex < totalPages; pageIndex++) {
                const startIndex = pageIndex * itemsPerPage;
                const endIndex = Math.min(startIndex + itemsPerPage, items.length);
                const pageItems = items.slice(startIndex, endIndex);
                
                const itemsWithGlobalIndex = pageItems.map((item, localIndex) => ({
                    ...item,
                    globalIndex: startIndex + localIndex
                }));
                
                const isFirstPage = pageIndex === 0;
                const isLastPage = pageIndex === totalPages - 1;
                const pageNumber = pageIndex + 1;
                
                const pdfTemplate = createPDFElement();
                pdfTemplate.innerHTML = generatePDFTemplateHTML(
                    itemsWithGlobalIndex, 
                    total, 
                    customerName, 
                    customerPhone, 
                    pageNumber, 
                    totalPages, 
                    isFirstPage, 
                    isLastPage
                );

                document.body.appendChild(pdfTemplate);
                await new Promise(resolve => setTimeout(resolve, 300));
                
                Object.assign(pdfTemplate.style, {
                    left: '0',
                    top: '0',
                    visibility: 'visible',
                    opacity: '1'
                });
                
                await new Promise(resolve => setTimeout(resolve, 100));
                
                const canvas = await html2canvas(pdfTemplate, {
                    scale: 1.5,
                    useCORS: true,  
                    allowTaint: true,
                    backgroundColor: '#ffffff',
                    logging: false,
                    width: pdfTemplate.offsetWidth,
                    height: pdfTemplate.offsetHeight
                });

                Object.assign(pdfTemplate.style, {
                    left: '-9999px',
                    top: '-9999px',
                    visibility: 'hidden',
                    opacity: '0'
                });

                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 210;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;

                pdf.addPage();
                pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                
                if (pdfTemplate && document.body.contains(pdfTemplate)) {
                    document.body.removeChild(pdfTemplate);
                }
            }

            const fileName = customerName ? 
                `bao-gia-sanko-${customerName.replace(/\s+/g, '-').toLowerCase()}.pdf` : 
                'bao-gia-sanko.pdf';
            
            pdf.save(fileName);
        }

        // =============== UTILITY FUNCTIONS ===============
        function formatPrice(price) {
            return new Intl.NumberFormat('vi-VN').format(price);
        }
        
        function getAllSelectedItems() {
            const selectedItems = [];
            selectedProducts.forEach((quantity, productId) => {
                const product = allProductsData.find(p => p.id == productId);
                if (product) {
                    selectedItems.push({
                        ...product,
                        quantity: quantity,
                        subtotal: product.price * quantity
                    });
                }
            });
            
            const validCustomProducts = customProducts.filter(p => p.name.trim() && p.price > 0);
            validCustomProducts.forEach(product => {
                product.quantity = 1; // Ensure custom products have quantity
                product.subtotal = product.price;
            });
            return [...selectedItems, ...validCustomProducts];
        }
        
        function calculateTotal(items) {
            return items.reduce((sum, item) => {
                return sum + (item.subtotal || (item.price * item.quantity));
            }, 0);
        }

        // =============== CUSTOM PRODUCTS FUNCTIONS ===============
        // Unified custom product management
        function manageCustomProduct(action, customId = null, field = null, value = null) {
            switch (action) {
                case 'add':
                    const newCustomId = `custom_${customProductIdCounter++}`;
                    customProducts.push({
                        id: newCustomId,
                        name: '',
                        price: 0,
                        isCustom: true,
                        quantity: 1
                    });
                    break;
                    
                case 'remove':
                    customProducts = customProducts.filter(p => p.id !== customId);
                    break;
                    
                case 'update':
                    const product = customProducts.find(p => p.id === customId);
                    if (product) {
                        if (field === 'name') {
                            product.name = value;
                        } else if (field === 'price') {
                            product.price = parseFloat(value) || 0;
                        }
                    }
                    break;
            }
            renderCustomProducts();
            updateUI();
        }

        // Wrapper functions for backward compatibility
        function addCustomProduct() {
            manageCustomProduct('add');
        }

        function removeCustomProduct(customId) {
            manageCustomProduct('remove', customId);
        }

        function updateCustomProduct(customId, field, value) {
            manageCustomProduct('update', customId, field, value);
        }

        function renderCustomProducts() {
            const container = document.getElementById('customProductsContainer');
            
            if (customProducts.length === 0) {
                container.innerHTML = '<div style="text-align: center; opacity: 0.7; font-style: italic;">Chưa có sản phẩm tự định nghĩa nào</div>';
                return;
            }

            container.innerHTML = customProducts.map(product => `
                <div class="custom-product-row">
                    <div class="custom-product-inputs">
                        <input 
                            type="text" 
                            placeholder="Tên sản phẩm..." 
                            value="${product.name}"
                            onchange="updateCustomProduct('${product.id}', 'name', this.value)"
                        />
                        <input 
                            type="number" 
                            placeholder="Giá tiền..." 
                            value="${product.price || ''}"
                            onchange="updateCustomProduct('${product.id}', 'price', this.value)"
                        />
                    </div>
                    <div class="custom-product-price">
                        ${product.price > 0 ? formatPrice(product.price) + ' VND' : 'Chưa có giá'}
                    </div>
                    <button class="remove-custom-btn" onclick="removeCustomProduct('${product.id}')">
                        ✕
                    </button>
                </div>
            `).join('');
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('quoteModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }
    </script>
</body>
</html>